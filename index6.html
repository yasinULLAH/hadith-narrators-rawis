
<!DOCTYPE html>
<html lang="ur" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Isnad Narrators Explorer</title>
  <style>
    :root {
      --primary: #1e88e5;
      --secondary: #26c6da;
      --dark: #212121;
      --light: #f5f5f5;
      --success: #43a047;
      --warning: #ffa000;
      --error: #e53935;
      --text-dark: #212121;
      --text-light: #f5f5f5;
      --bg-dark: #121212;
      --bg-light: #ffffff;
      --border-radius: 8px;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    
    .dark-theme {
      --primary: #42a5f5;
      --secondary: #4dd0e1;
      --bg-color: var(--bg-dark);
      --text-color: var(--text-light);
      --card-bg: #1e1e1e;
      --border-color: #333;
    }
    
    .light-theme {
      --primary: #1976d2;
      --secondary: #00acc1;
      --bg-color: var(--bg-light);
      --text-color: var(--text-dark);
      --card-bg: #ffffff;
      --border-color: #e0e0e0;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: var(--transition);
    }
    
    body {
      font-family: 'Noto Sans', 'Noto Nastaliq Urdu', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background-color: var(--primary);
      color: white;
      border-radius: var(--border-radius);
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }
    
    .header-title {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .header-controls {
      display: flex;
      gap: 1rem;
    }
    
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--secondary);
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: var(--transition);
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .btn-primary {
      background-color: var(--primary);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
    }
    
    .btn-success {
      background-color: var(--success);
    }
    
    .btn-warning {
      background-color: var(--warning);
    }
    
    .btn-error {
      background-color: var(--error);
    }
    
    .search-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .search-input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    
    .filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
      padding: 1rem;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 3fr;
      gap: 2rem;
    }
    
    .narrator-list {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 1rem;
      box-shadow: var(--shadow);
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .narrator-item {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: var(--border-radius);
      background-color: rgba(0,0,0,0.05);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .narrator-item:hover {
      background-color: var(--primary);
      color: white;
    }
    
    .narrator-item.active {
      background-color: var(--primary);
      color: white;
    }
    
    .narrator-detail {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }
    
    .narrator-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .narrator-name {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .narrator-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .narrator-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    
    .info-group {
      margin-bottom: 1rem;
    }
    
    .info-label {
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }
    
    .info-value {
      padding: 0.5rem;
      background-color: rgba(0,0,0,0.05);
      border-radius: var(--border-radius);
    }
    
    .tabs {
      display: flex;
      margin-top: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
    }
    
    .tab.active {
      border-bottom: 3px solid var(--primary);
      font-weight: bold;
    }
    
    .tab-content {
      padding: 1.5rem 0;
    }
    
    .visualization {
      height: 400px;
      background-color: rgba(0,0,0,0.05);
      border-radius: var(--border-radius);
      margin-top: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    
    .tree-viz, .graph-viz {
      width: 100%;
      height: 100%;
    }
    
    .notes-container {
      margin-top: 1rem;
    }
    
    .note-item {
      padding: 0.75rem;
      background-color: rgba(0,0,0,0.05);
      border-radius: var(--border-radius);
      margin-bottom: 0.5rem;
    }
    
    .note-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: var(--shadow);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      cursor: pointer;
      font-size: 1.5rem;
    }
    
    .modal-title {
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .onboarding {
      text-align: center;
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .onboarding-icon {
      font-size: 4rem;
      color: var(--primary);
      margin-bottom: 2rem;
    }
    
    .onboarding-title {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    
    .onboarding-text {
      margin-bottom: 2rem;
    }
    
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .toggle {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--primary);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    .fade-in {
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }
    
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    
    .slide-in {
      transform: translateX(30px);
      opacity: 0;
      animation: slideIn 0.5s forwards;
    }
    
    @keyframes slideIn {
      to { 
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .rotate {
      animation: rotate 1s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .narrator-info {
        grid-template-columns: 1fr;
      }
      
      .header-title {
        font-size: 1.2rem;
      }
      
      .header-controls {
        flex-wrap: wrap;
      }
    }
    
    @font-face {
      font-family: 'Noto Nastaliq Urdu';
      src: url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap');
    }
    
    @font-face {
      font-family: 'Noto Sans';
      src: url('https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap');
    }
    
    .material-icons {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
    }
	.viz-controls {
    z-index: 1000000;
}
  </style>
</head>
<body class="light-theme">

  <div class="container">
    <header>
      <div class="header-title">
        <span class="en">Isnad Narrators Explorer</span>
        <span class="ur">اسناد راویوں کا استکشاف</span>
      </div>
      <div class="header-controls">
        <div class="toggle-container">
          <span class="ur">اردو</span>
          <label class="toggle">
            <input type="checkbox" id="language-toggle">
            <span class="toggle-slider"></span>
          </label>
          <span class="en">English</span>
        </div>
        <div class="toggle-container">
          <span class="material-icons">light_mode</span>
          <label class="toggle">
            <input type="checkbox" id="theme-toggle">
            <span class="toggle-slider"></span>
          </label>
          <span class="material-icons">dark_mode</span>
        </div>
        <button class="btn btn-primary" id="import-btn">
          <span class="en">Import</span>
          <span class="ur">درآمد کریں</span>
        </button>
        <button class="btn btn-secondary" id="export-btn">
          <span class="en">Export</span>
          <span class="ur">برآمد کریں</span>
        </button>
        <button class="btn" id="settings-btn">
          <span class="material-icons">settings</span>
        </button>
      </div>
    </header>
    
    <div class="search-container">
      <input type="text" id="search-input" class="search-input" placeholder="Search narrators...">
      <button class="btn btn-primary" id="search-btn">
        <span class="material-icons">search</span>
      </button>
    </div>
    
    <div class="filter-container">
      <div class="filter-group">
        <div class="filter-title">
          <span class="en">Generation</span>
          <span class="ur">نسل</span>
        </div>
        <select id="generation-filter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-title">
          <span class="en">Area of Interest</span>
          <span class="ur">دلچسپی کا شعبہ</span>
        </div>
        <select id="interest-filter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-title">
          <span class="en">Tags</span>
          <span class="ur">ٹیگز</span>
        </div>
        <select id="tag-filter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-title">
          <span class="en">Category</span>
          <span class="ur">زمرہ</span>
        </div>
        <select id="category-filter">
          <option value="">All</option>
        </select>
      </div>
    </div>
    
    <div class="main-content">
      <div class="narrator-list" id="narrator-list">
        <!-- Narrator list items will be populated here -->
      </div>
      
      <div class="narrator-detail" id="narrator-detail">
        <div class="narrator-placeholder">
          <p class="en">Select a narrator to view details</p>
          <p class="ur">تفصیلات دیکھنے کے لئے راوی منتخب کریں</p>
        </div>
        
        <div class="narrator-content hidden">
          <div class="narrator-header">
            <h2 class="narrator-name" id="narrator-name"></h2>
            <div class="narrator-actions">
              <button class="btn" id="bookmark-btn">
                <span class="material-icons">bookmark_border</span>
              </button>
              <button class="btn" id="category-btn">
                <span class="material-icons">category</span>
              </button>
              <button class="btn" id="note-btn">
                <span class="material-icons">note_add</span>
              </button>
            </div>
          </div>
          
          <div class="narrator-info">
            <div class="info-group">
              <div class="info-label">
                <span class="en">Grade</span>
                <span class="ur">درجہ</span>
              </div>
              <div class="info-value" id="narrator-grade"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Birth</span>
                <span class="ur">پیدائش</span>
              </div>
              <div class="info-value" id="narrator-birth"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Death</span>
                <span class="ur">وفات</span>
              </div>
              <div class="info-value" id="narrator-death"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Places of Stay</span>
                <span class="ur">قیام کی جگہیں</span>
              </div>
              <div class="info-value" id="narrator-places"></div>
            </div>
          </div>
          
          <div class="tabs">
            <div class="tab active" data-tab="relations">
              <span class="en">Relations</span>
              <span class="ur">تعلقات</span>
            </div>
            <div class="tab" data-tab="visualization">
              <span class="en">Visualization</span>
              <span class="ur">بصری تجسیم</span>
            </div>
            <div class="tab" data-tab="notes">
              <span class="en">Notes</span>
              <span class="ur">نوٹس</span>
            </div>
          </div>
          
          <div class="tab-content" id="relations-tab">
            <div class="info-group">
              <div class="info-label">
                <span class="en">Parents</span>
                <span class="ur">والدین</span>
              </div>
              <div class="info-value" id="narrator-parents"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Spouse</span>
                <span class="ur">شریک حیات</span>
              </div>
              <div class="info-value" id="narrator-spouse"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Siblings</span>
                <span class="ur">بہن بھائی</span>
              </div>
              <div class="info-value" id="narrator-siblings"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Children</span>
                <span class="ur">اولاد</span>
              </div>
              <div class="info-value" id="narrator-children"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Teachers</span>
                <span class="ur">استاد</span>
              </div>
              <div class="info-value" id="narrator-teachers"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Students</span>
                <span class="ur">طلبا</span>
              </div>
              <div class="info-value" id="narrator-students"></div>
            </div>
          </div>
          
          <div class="tab-content hidden" id="visualization-tab">
            <div class="visualization">
              <div class="tree-viz" id="tree-visualization"></div>
              <div class="graph-viz hidden" id="graph-visualization"></div>
              
              <div class="viz-controls">
                <button class="btn" id="tree-view-btn">
                  <span class="en">Tree View</span>
                  <span class="ur">درخت نظارہ</span>
                </button>
                <button class="btn" id="graph-view-btn">
                  <span class="en">Graph View</span>
                  <span class="ur">گراف نظارہ</span>
                </button>
              </div>
            </div>
          </div>
          
          <div class="tab-content hidden" id="notes-tab">
            <textarea id="note-input" class="note-input" placeholder="Add a new note..."></textarea>
            <button class="btn btn-primary" id="save-note-btn">
              <span class="en">Save Note</span>
              <span class="ur">نوٹ محفوظ کریں</span>
            </button>
            
            <div class="notes-container" id="notes-container">
              <!-- Notes will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>

<!-- Modals -->

  <div class="modal" id="onboarding-modal">
    <div class="modal-content">
      <span class="modal-close" id="onboarding-close">&times;</span>
      <div class="onboarding">
        <div class="onboarding-icon">📚</div>
        <h1 class="onboarding-title">
          <span class="en">Welcome to Isnad Narrators Explorer</span>
          <span class="ur">اسناد راویوں کے استکشاف میں خوش آمدید</span>
        </h1>
        <p class="onboarding-text">
          <span class="en">This application helps you explore and understand the relationships between narrators in Islamic tradition. Search, filter, and visualize narrator connections, add your own notes, and more.</span>
          <span class="ur">یہ ایپلیکیشن آپ کو اسلامی روایت میں راویوں کے درمیان تعلقات کو تلاش کرنے اور سمجھنے میں مدد کرتی ہے۔ راوی کنکشنز کو تلاش کریں، فلٹر کریں، اور ویژولائز کریں، اپنے نوٹس شامل کریں، اور بہت کچھ۔</span>
        </p>
        <button class="btn btn-primary" id="start-app-btn">
          <span class="en">Start Exploring</span>
          <span class="ur">دریافت شروع کریں</span>
        </button>
      </div>
    </div>
    </div>

  <div class="modal" id="disclaimer-modal">
    <div class="modal-content">
      <span class="modal-close" id="disclaimer-close">&times;</span>
      <h2 class="modal-title">
        <span class="en">Disclaimer</span>
        <span class="ur">دستبرداری</span>
      </h2>
      <p>
        <span class="en">
          This application provides information about narrators of Islamic traditions for educational purposes only. The data may not be complete or entirely accurate. Users are encouraged to verify information from authoritative sources.
        </span>
        <span class="ur">
          یہ ایپلیکیشن صرف تعلیمی مقاصد کے لیے اسلامی روایات کے راویوں کے بارے میں معلومات فراہم کرتی ہے۔ ڈیٹا مکمل یا مکمل طور پر درست نہیں ہو سکتا ہے۔ صارفین کو مستند ذرائع سے معلومات کی تصدیق کرنے کی ترغیب دی جاتی ہے۔
        </span>
      </p>
      <button class="btn btn-primary mt-4" id="accept-disclaimer-btn">
        <span class="en">I Understand</span>
        <span class="ur">میں سمجھتا ہوں</span>
      </button>
    </div>
</div>

  <div class="modal" id="category-modal">
    <div class="modal-content">
      <span class="modal-close" id="category-modal-close">&times;</span>
      <h2 class="modal-title">
        <span class="en">Manage Categories</span>
        <span class="ur">زمرہ جات کا انتظام کریں</span>
      </h2>
      <div id="categories-list">
        <!-- Categories will be populated here -->
      </div>
      <div class="mt-4">
        <input type="text" id="new-category-input" class="search-input" placeholder="New category name">
        <button class="btn btn-primary" id="add-category-btn">
          <span class="en">Add Category</span>
          <span class="ur">زمرہ شامل کریں</span>
        </button>
      </div>
      <div class="mt-4">
        <button class="btn" id="assign-category-btn">
          <span class="en">Assign Selected</span>
          <span class="ur">منتخب کردہ تفویض کریں</span>
        </button>
      </div>
    </div>
    </div>

  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <span class="modal-close" id="settings-modal-close">&times;</span>
      <h2 class="modal-title">
        <span class="en">Settings</span>
        <span class="ur">ترتیبات</span>
      </h2>
      <div class="setting-group">
        <h3>
          <span class="en">Language</span>
          <span class="ur">زبان</span>
        </h3>
        <div class="toggle-container">
          <span class="ur">اردو</span>
          <label class="toggle">
            <input type="checkbox" id="settings-language-toggle">
            <span class="toggle-slider"></span>
          </label>
          <span class="en">English</span>
        </div>
      </div>
      <div class="setting-group">
        <h3>
          <span class="en">Theme</span>
          <span class="ur">تھیم</span>
        </h3>
        <div class="toggle-container">
          <span class="material-icons">light_mode</span>
          <label class="toggle">
            <input type="checkbox" id="settings-theme-toggle">
            <span class="toggle-slider"></span>
          </label>
          <span class="material-icons">dark_mode</span>
        </div>
      </div>
      <div class="setting-group">
        <h3>
          <span class="en">Reset Data</span>
          <span class="ur">ڈیٹا ری سیٹ کریں</span>
        </h3>
        <button class="btn btn-error" id="reset-data-btn">
          <span class="en">Reset All Data</span>
          <span class="ur">تمام ڈیٹا ری سیٹ کریں</span>
        </button>
      </div>
      <div class="setting-group">
        <h3>
          <span class="en">About</span>
          <span class="ur">ہمارے بارے میں</span>
        </h3>
        <p>
          <span class="en">Isnad Narrators Explorer v1.0</span>
          <span class="ur">اسناد راویوں کا استکشاف v1.0</span>
        </p>
      </div>
    </div>
    </div>

  <div class="modal" id="import-modal">
    <div class="modal-content">
      <span class="modal-close" id="import-modal-close">&times;</span>
      <h2 class="modal-title">
        <span class="en">Import Data</span>
        <span class="ur">ڈیٹا درآمد کریں</span>
      </h2>
      <p>
        <span class="en">Import narrator data from CSV or JSON file.</span>
        <span class="ur">CSV یا JSON فائل سے راوی ڈیٹا درآمد کریں۔</span>
      </p>
      <input type="file" id="import-file" accept=".csv,.json">
      <button class="btn btn-primary mt-4" id="import-file-btn">
        <span class="en">Import</span>
        <span class="ur">درآمد کریں</span>
      </button>
    </div>
</div>

  <div class="modal" id="export-modal">
    <div class="modal-content">
      <span class="modal-close" id="export-modal-close">&times;</span>
      <h2 class="modal-title">
        <span class="en">Export Data</span>
        <span class="ur">ڈیٹا برآمد کریں</span>
      </h2>
      <p>
        <span class="en">Export all data including narrators, notes, bookmarks, and categories.</span>
        <span class="ur">راویوں، نوٹس، بک مارکس، اور زمرہ جات سمیت تمام ڈیٹا برآمد کریں۔</span>
      </p>
      <button class="btn btn-primary mt-4" id="export-file-btn">
        <span class="en">Export as JSON</span>
        <span class="ur">JSON کے طور پر برآمد کریں</span>
      </button>
    </div>
</div>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&family=Noto+Sans&display=swap" rel="stylesheet">
<script>


// Core variables
let db;
let currentNarrator = null;
let currentLanguage = 'en';
let currentTheme = 'light';
let isLoading = false;
let currentPage = 1;
let itemsPerPage = 20;
let totalItems = 0;
let narrators = []; // In-memory cache for faster access

// Database configuration
const DB_NAME = 'IsnadNarratorsDB';
const DB_VERSION = 1;
const STORES = {
  NARRATORS: 'narrators',
  NOTES: 'notes',
  BOOKMARKS: 'bookmarks',
  SETTINGS: 'settings'
};

// Initialize application
document.addEventListener('DOMContentLoaded', async () => {
  try {
    // Show loading state
    showLoader('Initializing application...');
    
    // Open database
    await openDatabase();
    
    // Load settings
    await loadSettings();
    
    // Check if we need to import initial data
    const hasData = await hasInitialData();
    if (!hasData) {
      await importInitialData();
    } else {
      // Load all narrators into memory for better performance
      narrators = await getAllNarrators();
      console.log(`Loaded ${narrators.length} narrators into memory`);
    }
    
    // Setup UI and listeners
    setupEventListeners();
    applyLanguageAndTheme();
    populateFilterOptions();
    await loadNarratorsList();
    
    // Hide loader
    hideLoader();
    
    // Show onboarding if first time
    const hasSeenOnboarding = await getSetting('hasSeenOnboarding');
    if (!hasSeenOnboarding) {
      showOnboarding();
    }
  } catch (error) {
    console.error('Initialization error:', error);
    showError('Failed to initialize application. Please refresh the page.');
    hideLoader();
  }
});

// Open and initialize database
function openDatabase() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = event => {
      reject(new Error('Failed to open database'));
    };
    
    request.onupgradeneeded = event => {
      const db = event.target.result;
      
      // Create narrators store
      if (!db.objectStoreNames.contains(STORES.NARRATORS)) {
        const narratorsStore = db.createObjectStore(STORES.NARRATORS, { keyPath: 'scholar_indx' });
        narratorsStore.createIndex('name', 'name', { unique: false });
        narratorsStore.createIndex('grade', 'grade', { unique: false });
      }
      
      // Create notes store
      if (!db.objectStoreNames.contains(STORES.NOTES)) {
        const notesStore = db.createObjectStore(STORES.NOTES, { keyPath: 'id', autoIncrement: true });
        notesStore.createIndex('narrator_id', 'narrator_id', { unique: false });
      }
      
      // Create bookmarks store
      if (!db.objectStoreNames.contains(STORES.BOOKMARKS)) {
        db.createObjectStore(STORES.BOOKMARKS, { keyPath: 'narrator_id' });
      }
      
      // Create settings store
      if (!db.objectStoreNames.contains(STORES.SETTINGS)) {
        db.createObjectStore(STORES.SETTINGS, { keyPath: 'key' });
      }
    };
    
    request.onsuccess = event => {
      db = event.target.result;
      resolve(db);
    };
  });
}

// Check if we have initial data
async function hasInitialData() {
  try {
    const count = await countNarrators();
    return count > 0;
  } catch (error) {
    console.error('Error checking initial data:', error);
    return false;
  }
}

// Count narrators
function countNarrators() {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.NARRATORS], 'readonly');
    const store = transaction.objectStore(STORES.NARRATORS);
    const countRequest = store.count();
    
    countRequest.onsuccess = () => resolve(countRequest.result);
    countRequest.onerror = () => reject(new Error('Failed to count narrators'));
  });
}

// Import initial data from CSV file with web worker for non-blocking operation
async function importInitialData() {
  try {
    showLoader('Downloading data file...');
    
    // Fetch CSV file
    const response = await fetch('all_rawis.csv');
    if (!response.ok) throw new Error('Failed to fetch CSV file');
    
    const csvText = await response.text();
    
    if (window.Worker) {
      // Use web worker for non-blocking CSV parsing
      await importCSVWithWorker(csvText);
    } else {
      // Fallback to standard import
      await importCSV(csvText);
    }
    
    // Load all narrators into memory
    narrators = await getAllNarrators();
    console.log(`Loaded ${narrators.length} narrators into memory`);
    
    // Mark as imported
    await saveSetting('dataImported', true);
  } catch (error) {
    console.error('Import error:', error);
    showError('Failed to import initial data. Please refresh and try again.');
  }
}

// Import CSV using web worker
function importCSVWithWorker(csvText) {
  return new Promise((resolve, reject) => {
    // Create inline worker with blob URL
    const workerCode = `
      self.onmessage = function(e) {
        const csvText = e.data;
        const lines = csvText.split('\\n');
        if (lines.length < 2) {
          self.postMessage({ error: 'Invalid CSV format' });
          return;
        }
        
        const headers = lines[0].split(',');
        const totalLines = lines.length - 1;
        
        // Process in chunks
        const chunkSize = 100;
        const totalChunks = Math.ceil(totalLines / chunkSize);
        
        for (let chunk = 0; chunk < totalChunks; chunk++) {
          const narrators = [];
          const start = chunk * chunkSize + 1; // Skip header
          const end = Math.min(start + chunkSize, lines.length);
          
          for (let i = start; i < end; i++) {
            if (!lines[i] || !lines[i].trim()) continue;
            
            try {
              const values = parseCSVLine(lines[i]);
              const narrator = {};
              
              // Map CSV values to object properties
              headers.forEach((header, index) => {
                narrator[header.trim()] = values[index] || '';
              });
              
              // Ensure scholar_indx is numeric
              if (narrator.scholar_indx) {
                narrator.scholar_indx = parseInt(narrator.scholar_indx, 10) || narrator.scholar_indx;
              }
              
              narrators.push(narrator);
            } catch (error) {
              console.warn(\`Error parsing line \${i}\`);
            }
          }
          
          self.postMessage({
            chunk: chunk,
            totalChunks: totalChunks,
            narrators: narrators
          });
        }
        
        self.postMessage({ done: true });
      };
      
      function parseCSVLine(line) {
        const result = [];
        let inQuotes = false;
        let currentValue = '';
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(currentValue);
            currentValue = '';
          } else {
            currentValue += char;
          }
        }
        
        // Add the last value
        result.push(currentValue);
        
        return result;
      }
    `;
    
    const blob = new Blob([workerCode], { type: 'application/javascript' });
    const worker = new Worker(URL.createObjectURL(blob));
    
    worker.onmessage = async function(e) {
      if (e.data.error) {
        reject(new Error(e.data.error));
        worker.terminate();
        return;
      }
      
      if (e.data.done) {
        resolve();
        worker.terminate();
        return;
      }
      
      // Update progress
      updateLoader(`Importing data (${Math.round((e.data.chunk / e.data.totalChunks) * 100)}%)...`);
      
      // Save chunk to database
      try {
        await saveNarrators(e.data.narrators);
      } catch (error) {
        console.error('Error saving narrators:', error);
      }
    };
    
    worker.onerror = function(error) {
      reject(error);
      worker.terminate();
    };
    
    worker.postMessage(csvText);
  });
}

// Standard CSV import (fallback)
async function importCSV(csvText) {
  const lines = csvText.split('\n');
  if (lines.length < 2) throw new Error('Invalid CSV format');
  
  const headers = lines[0].split(',');
  const totalLines = lines.length - 1;
  
  // Process in chunks to prevent UI freezing
  const chunkSize = 50;
  const totalChunks = Math.ceil(totalLines / chunkSize);
  
  for (let chunk = 0; chunk < totalChunks; chunk++) {
    // Update progress
    updateLoader(`Importing data (${Math.round((chunk / totalChunks) * 100)}%)...`);
    
    // Process chunk
    const narratorsToAdd = [];
    const start = chunk * chunkSize + 1; // Skip header
    const end = Math.min(start + chunkSize, lines.length);
    
    for (let i = start; i < end; i++) {
      if (!lines[i] || !lines[i].trim()) continue;
      
      try {
        const values = parseCSVLine(lines[i]);
        const narrator = {};
        
        // Map CSV values to object properties
        headers.forEach((header, index) => {
          narrator[header.trim()] = values[index] || '';
        });
        
        // Ensure scholar_indx is numeric
        if (narrator.scholar_indx) {
          narrator.scholar_indx = parseInt(narrator.scholar_indx, 10) || narrator.scholar_indx;
        }
        
        narratorsToAdd.push(narrator);
      } catch (error) {
        console.warn(`Error parsing line ${i}:`, error);
      }
    }
    
    // Save chunk to database
    if (narratorsToAdd.length > 0) {
      await saveNarrators(narratorsToAdd);
    }
    
    // Yield to UI thread
    await new Promise(resolve => setTimeout(resolve, 0));
  }
}

// Parse CSV line handling quotes correctly
function parseCSVLine(line) {
  const result = [];
  let inQuotes = false;
  let currentValue = '';
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      result.push(currentValue);
      currentValue = '';
    } else {
      currentValue += char;
    }
  }
  
  // Add the last value
  result.push(currentValue);
  
  return result;
}

// Save narrators to database
function saveNarrators(narratorsToSave) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    if (!narratorsToSave || narratorsToSave.length === 0) return resolve();
    
    const transaction = db.transaction([STORES.NARRATORS], 'readwrite');
    const store = transaction.objectStore(STORES.NARRATORS);
    
    // Track completion
    let completed = 0;
    
    // Add each narrator
    narratorsToSave.forEach(narrator => {
      const request = store.put(narrator);
      
      request.onsuccess = () => {
        completed++;
        if (completed === narratorsToSave.length) resolve();
      };
      
      request.onerror = event => {
        console.error('Error saving narrator:', event.target.error);
        completed++;
        if (completed === narratorsToSave.length) resolve();
      };
    });
    
    // Handle transaction errors
    transaction.onerror = event => reject(event.target.error);
  });
}

// Load settings
async function loadSettings() {
  try {
    // Load language setting
    const savedLanguage = await getSetting('language');
    if (savedLanguage) currentLanguage = savedLanguage;
    
    // Load theme setting
    const savedTheme = await getSetting('theme');
    if (savedTheme) currentTheme = savedTheme;
  } catch (error) {
    console.error('Error loading settings:', error);
    // Use defaults if settings can't be loaded
  }
}

// Get a setting from database
function getSetting(key) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.SETTINGS], 'readonly');
    const store = transaction.objectStore(STORES.SETTINGS);
    const request = store.get(key);
    
    request.onsuccess = event => {
      const result = event.target.result;
      resolve(result ? result.value : null);
    };
    
    request.onerror = event => reject(event.target.error);
  });
}

// Save a setting to database
function saveSetting(key, value) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.SETTINGS], 'readwrite');
    const store = transaction.objectStore(STORES.SETTINGS);
    const request = store.put({ key, value });
    
    request.onsuccess = () => resolve();
    request.onerror = event => reject(event.target.error);
  });
}

// Apply language and theme
function applyLanguageAndTheme() {
  // Apply language
  document.documentElement.lang = currentLanguage;
  document.documentElement.dir = currentLanguage === 'ur' ? 'rtl' : 'ltr';
  
  // Apply theme
  document.body.className = currentTheme === 'dark' ? 'dark-theme' : 'light-theme';
  
  // Update UI elements
  updateLanguageDisplay();
  updateThemeToggles();
}

// Update language display
function updateLanguageDisplay() {
  // Hide all language elements
  document.querySelectorAll('.en, .ur').forEach(el => {
    el.style.display = 'none';
  });
  
  // Show current language elements
  document.querySelectorAll('.' + currentLanguage).forEach(el => {
    el.style.display = 'inline-block';
  });
}

// Update theme toggle buttons
function updateThemeToggles() {
  document.querySelectorAll('#theme-toggle, #settings-theme-toggle').forEach(toggle => {
    toggle.checked = currentTheme === 'dark';
  });
  
  document.querySelectorAll('#language-toggle, #settings-language-toggle').forEach(toggle => {
    toggle.checked = currentLanguage === 'en';
  });
}

// Get all narrators
function getAllNarrators() {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.NARRATORS], 'readonly');
    const store = transaction.objectStore(STORES.NARRATORS);
    const request = store.getAll();
    
    request.onsuccess = event => resolve(event.target.result);
    request.onerror = event => reject(event.target.error);
  });
}

// Load narrators list with pagination and filtering
async function loadNarratorsList(page = 1, filter = {}) {
  try {
    showLoader('Loading narrators...');
    
    // Use in-memory filtering for better performance
    const filteredNarrators = filterNarrators(narrators, filter);
    totalItems = filteredNarrators.length;
    currentPage = page;
    
    // Get current page items
    const startIndex = (page - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageNarrators = filteredNarrators.slice(startIndex, endIndex);
    
    // Render list
    renderNarratorsList(pageNarrators);
    renderPagination();
    
    hideLoader();
  } catch (error) {
    console.error('Error loading narrators list:', error);
    showError('Failed to load narrators. Please try again.');
    hideLoader();
  }
}

// Filter narrators in memory
function filterNarrators(narrators, filter) {
  return narrators.filter(narrator => {
    // Search filter
    if (filter.search && !narrator.name.toLowerCase().includes(filter.search.toLowerCase())) {
      return false;
    }
    
    // Generation filter
    if (filter.generation && narrator.grade !== filter.generation) {
      return false;
    }
    
    // Interest filter
    if (filter.interest && (!narrator.area_of_interest || !narrator.area_of_interest.includes(filter.interest))) {
      return false;
    }
    
    // Tag filter
    if (filter.tag && (!narrator.tags || !narrator.tags.includes(filter.tag))) {
      return false;
    }
    
    return true;
  });
}

// Populate filter dropdowns with unique values
function populateFilterOptions() {
  // Extract unique values
  const generations = new Set();
  const interests = new Set();
  const tags = new Set();
  
  narrators.forEach(narrator => {
    // Add generation
    if (narrator.grade) {
      generations.add(narrator.grade);
    }
    
    // Add interests
    if (narrator.area_of_interest) {
      narrator.area_of_interest.split(',').forEach(interest => {
        interests.add(interest.trim());
      });
    }
    
    // Add tags
    if (narrator.tags) {
      narrator.tags.split(',').forEach(tag => {
        // Extract tag name from format "TagName [TagValue]"
        const match = tag.match(/\[(.*?)\]/);
        if (match) {
          tags.add(match[1]);
        } else {
          tags.add(tag.trim());
        }
      });
    }
  });
  
  // Populate generation dropdown
  const generationSelect = document.getElementById('generation-filter');
  if (generationSelect) {
    generationSelect.innerHTML = '<option value="">All</option>';
    
    Array.from(generations).sort().forEach(generation => {
      const option = document.createElement('option');
      option.value = generation;
      option.textContent = generation;
      generationSelect.appendChild(option);
    });
  }
  
  // Populate interest dropdown
  const interestSelect = document.getElementById('interest-filter');
  if (interestSelect) {
    interestSelect.innerHTML = '<option value="">All</option>';
    
    Array.from(interests).sort().forEach(interest => {
      const option = document.createElement('option');
      option.value = interest;
      option.textContent = interest;
      interestSelect.appendChild(option);
    });
  }
  
  // Populate tag dropdown
  const tagSelect = document.getElementById('tag-filter');
  if (tagSelect) {
    tagSelect.innerHTML = '<option value="">All</option>';
    
    Array.from(tags).sort().forEach(tag => {
      const option = document.createElement('option');
      option.value = tag;
      option.textContent = tag;
      tagSelect.appendChild(option);
    });
  }
}

// Render narrators list
function renderNarratorsList(narrators) {
  const container = document.getElementById('narrator-list');
  if (!container) return;
  
  // Clear container
  container.innerHTML = '';
  
  // Handle empty state
  if (narrators.length === 0) {
    container.innerHTML = `
      <div class="narrator-placeholder">
        <p class="en">No narrators found</p>
        <p class="ur">کوئی راوی نہیں ملا</p>
      </div>
    `;
    return;
  }
  
  // Create narrator items
  narrators.forEach(narrator => {
    const item = document.createElement('div');
    item.className = 'narrator-item';
    item.dataset.id = narrator.scholar_indx;
    item.innerHTML = narrator.name;
    
    // Add click handler
    item.addEventListener('click', () => {
      // Remove active class from all items
      document.querySelectorAll('.narrator-item').forEach(el => {
        el.classList.remove('active');
      });
      
      // Add active class to clicked item
      item.classList.add('active');
      
      // Show narrator details
      showNarratorDetails(narrator);
    });
    
    container.appendChild(item);
  });
}

// Render pagination controls
function renderPagination() {
  const container = document.getElementById('narrator-list');
  if (!container) return;
  
  // Calculate pages
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  if (totalPages <= 1) return;
  
  // Create pagination container
  const pagination = document.createElement('div');
  pagination.className = 'pagination';
  
  // Previous button
  const prevBtn = document.createElement('button');
  prevBtn.className = 'btn pagination-btn';
  prevBtn.innerHTML = '&laquo;';
  prevBtn.disabled = currentPage === 1;
  prevBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      loadNarratorsList(currentPage - 1, getCurrentFilters());
    }
  });
  
  // Next button
  const nextBtn = document.createElement('button');
  nextBtn.className = 'btn pagination-btn';
  nextBtn.innerHTML = '&raquo;';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.addEventListener('click', () => {
    if (currentPage < totalPages) {
      loadNarratorsList(currentPage + 1, getCurrentFilters());
    }
  });
  
  // Page info
  const pageInfo = document.createElement('span');
  pageInfo.className = 'page-info';
  pageInfo.innerHTML = `
    <span class="en">Page ${currentPage} of ${totalPages}</span>
    <span class="ur">صفحہ ${currentPage} از ${totalPages}</span>
  `;
  
  // Add to container
  pagination.appendChild(prevBtn);
  pagination.appendChild(pageInfo);
  pagination.appendChild(nextBtn);
  
  container.appendChild(pagination);
  
  // Update language display
  updateLanguageDisplay();
}

// Get current filters from UI
function getCurrentFilters() {
  const filter = {};
  
  // Search filter
  const searchInput = document.getElementById('search-input');
  if (searchInput && searchInput.value.trim()) {
    filter.search = searchInput.value.trim();
  }
  
  // Generation filter
  const generationSelect = document.getElementById('generation-filter');
  if (generationSelect && generationSelect.value) {
    filter.generation = generationSelect.value;
  }
  
  // Interest filter
  const interestSelect = document.getElementById('interest-filter');
  if (interestSelect && interestSelect.value) {
    filter.interest = interestSelect.value;
  }
  
  // Tag filter
  const tagSelect = document.getElementById('tag-filter');
  if (tagSelect && tagSelect.value) {
    filter.tag = tagSelect.value;
  }
  
  return filter;
}

// Show narrator details
function showNarratorDetails(narrator) {
  currentNarrator = narrator;
  
  // Show details container and hide placeholder
  const placeholder = document.querySelector('.narrator-placeholder');
  const content = document.querySelector('.narrator-content');
  
  if (placeholder && content) {
    placeholder.classList.add('hidden');
    content.classList.remove('hidden');
  }
  
  // Update basic info
  updateElementText('narrator-name', narrator.name);
  updateElementText('narrator-grade', narrator.grade || 'N/A');
  updateElementText('narrator-birth', narrator.birth_date_place || 'N/A');
  updateElementText('narrator-death', narrator.death_date_place || 'N/A');
  updateElementText('narrator-places', narrator.places_of_stay || 'N/A');
  
  // Update relationships
  updateElementText('narrator-parents', narrator.parents || 'N/A');
  updateElementText('narrator-spouse', narrator.spouse || 'N/A');
  updateElementText('narrator-siblings', narrator.siblings || 'N/A');
  updateElementText('narrator-children', narrator.children || 'N/A');
  updateElementText('narrator-teachers', narrator.teachers || 'N/A');
  updateElementText('narrator-students', narrator.students || 'N/A');
  
  // Update bookmark status
  updateBookmarkStatus();
  
  // Load notes
  loadNarratorNotes();
  
  // Generate visualizations after a delay to prevent UI lag
  setTimeout(() => {
    generateVisualizations();
  }, 100);
}

// Helper to update element text content
function updateElementText(elementId, text) {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = text;
  }
}

// Generate visualizations
function generateVisualizations() {
  if (!currentNarrator) return;
  
  // Get active tab
  const activeTab = document.querySelector('.tab.active');
  if (activeTab && activeTab.dataset.tab !== 'visualization') {
    return; // Don't generate if visualization tab is not active
  }
  
  const treeViz = document.getElementById('tree-visualization');
  const graphViz = document.getElementById('graph-visualization');
  
  if (!treeViz || !graphViz) return;
  
  // Tree visualization
  treeViz.innerHTML = `
    <svg width="100%" height="100%" viewBox="0 0 1000 400">
      <g transform="translate(500, 50)">
        <!-- Center node (current narrator) -->
        <circle cx="0" cy="0" r="30" fill="${currentTheme === 'dark' ? '#42a5f5' : '#1976d2'}" />
        <text x="0" y="5" text-anchor="middle" fill="white" font-size="12">${currentNarrator.name.slice(0, 10)}...</text>
        
        <!-- Teachers -->
        ${generateTreeNodes(parseRelationships(currentNarrator.teachers), -200, 100, 'Teachers')}
        
        <!-- Students -->
        ${generateTreeNodes(parseRelationships(currentNarrator.students), 200, 100, 'Students')}
        
        <!-- Children -->
        ${generateTreeNodes(parseRelationships(currentNarrator.children), 0, 150, 'Children')}
      </g>
    </svg>
  `;
  
  // Graph visualization
  graphViz.innerHTML = `
    <svg width="100%" height="100%" viewBox="0 0 1000 400">
      <g transform="translate(500, 200)">
        <!-- Center node (current narrator) -->
        <circle cx="0" cy="0" r="40" fill="${currentTheme === 'dark' ? '#42a5f5' : '#1976d2'}" />
        <text x="0" y="5" text-anchor="middle" fill="white" font-size="14">${currentNarrator.name.slice(0, 10)}...</text>
        
        <!-- Relationships -->
        ${generateGraphConnections()}
      </g>
    </svg>
  `;
}

// Parse relationship strings
function parseRelationships(relationshipString) {
  if (!relationshipString) return [];
  
  return relationshipString.split(', ')
    .map(name => name.trim())
    .filter(name => name && name !== 'NA' && name !== 'others');
}

// Generate tree nodes
function generateTreeNodes(items, xOffset, yOffset, labelText) {
  if (items.length === 0) return '';
  
  const maxItems = 5;
  const displayItems = items.slice(0, maxItems);
  const angleStep = Math.PI / (displayItems.length + 1);
  
  let result = `
    <text x="${xOffset}" y="${yOffset - 60}" text-anchor="middle" fill="${currentTheme === 'dark' ? '#f5f5f5' : '#212121'}" font-size="14">${labelText}</text>
    <path d="M 0 0 L ${xOffset} ${yOffset - 20}" stroke="${currentTheme === 'dark' ? '#4dd0e1' : '#00acc1'}" stroke-width="2" fill="none" />
  `;
  
  displayItems.forEach((item, i) => {
    const angle = (i + 1) * angleStep;
    const x = xOffset + 80 * Math.cos(angle) - 80;
    const y = yOffset + 80 * Math.sin(angle);
    
    result += `
      <circle cx="${x}" cy="${y}" r="25" fill="${currentTheme === 'dark' ? '#4dd0e1' : '#00acc1'}" />
      <text x="${x}" y="${y + 5}" text-anchor="middle" fill="white" font-size="10">${item.slice(0, 8)}...</text>
      <path d="M ${xOffset} ${yOffset - 20} L ${x} ${y}" stroke="${currentTheme === 'dark' ? '#4dd0e1' : '#00acc1'}" stroke-width="1.5" fill="none" />
    `;
  });
  
  if (items.length > maxItems) {
    result += `
      <text x="${xOffset}" y="${yOffset + 60}" text-anchor="middle" fill="${currentTheme === 'dark' ? '#f5f5f5' : '#212121'}" font-size="12">+${items.length - maxItems} more</text>
    `;
  }
  
  return result;
}

// Generate graph connections
function generateGraphConnections() {
  const relationships = [
    ...parseRelationships(currentNarrator.teachers || ''),
    ...parseRelationships(currentNarrator.students || ''),
    ...parseRelationships(currentNarrator.children || '')
  ];
  
  if (relationships.length === 0) return '';
  
  const maxNodes = 8;
  const displayNodes = relationships.slice(0, maxNodes);
  const radius = 150;
  
  let result = '';
  
  displayNodes.forEach((item, i) => {
    const angle = (i * 2 * Math.PI) / displayNodes.length;
    const x = radius * Math.cos(angle);
    const y = radius * Math.sin(angle);
    
    // Determine relationship type
    let relationshipType = 'Family';
    let color = '#ffa000';
    
    if (currentNarrator.teachers && currentNarrator.teachers.includes(item)) {
      relationshipType = 'Teacher';
      color = '#e53935';
    } else if (currentNarrator.students && currentNarrator.students.includes(item)) {
      relationshipType = 'Student';
      color = '#43a047';
    }
    
    result += `
      <circle cx="${x}" cy="${y}" r="30" fill="${color}" />
      <text x="${x}" y="${y - 5}" text-anchor="middle" fill="white" font-size="10">${item.slice(0, 8)}...</text>
      <text x="${x}" y="${y + 10}" text-anchor="middle" fill="white" font-size="8">${relationshipType}</text>
      <path d="M 0 0 L ${x} ${y}" stroke="${color}" stroke-width="1.5" stroke-dasharray="5,3" fill="none" />
    `;
  });
  
  if (relationships.length > maxNodes) {
    result += `
      <text x="0" y="${radius + 50}" text-anchor="middle" fill="${currentTheme === 'dark' ? '#f5f5f5' : '#212121'}" font-size="14">+${relationships.length - maxNodes} more connections</text>
    `;
  }
  
  return result;
}

// Update bookmark status
async function updateBookmarkStatus() {
  if (!currentNarrator) return;
  
  const bookmarkBtn = document.getElementById('bookmark-btn');
  if (!bookmarkBtn) return;
  
  const isBookmarked = await isNarratorBookmarked(currentNarrator.scholar_indx);
  
  bookmarkBtn.innerHTML = isBookmarked
    ? '<span class="material-icons">bookmark</span>'
    : '<span class="material-icons">bookmark_border</span>';
}

// Check if narrator is bookmarked
function isNarratorBookmarked(narratorId) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.BOOKMARKS], 'readonly');
    const store = transaction.objectStore(STORES.BOOKMARKS);
    const request = store.get(narratorId);
    
    request.onsuccess = event => {
      resolve(!!event.target.result);
    };
    
    request.onerror = event => {
      console.error('Error checking bookmark:', event.target.error);
      resolve(false);
    };
  });
}

// Load narrator notes
async function loadNarratorNotes() {
  if (!currentNarrator) return;
  
  const notesContainer = document.getElementById('notes-container');
  if (!notesContainer) return;
  
  // Clear container
  notesContainer.innerHTML = '';
  
  // Get notes
  const notes = await getNarratorNotes(currentNarrator.scholar_indx);
  
  // Handle empty state
  if (notes.length === 0) {
    notesContainer.innerHTML = `
      <div class="note-placeholder">
        <p class="en">No notes added yet</p>
        <p class="ur">ابھی تک کوئی نوٹ نہیں شامل کیا گیا</p>
      </div>
    `;
    return;
  }
  
  // Render notes
  notes.forEach(note => {
    const noteEl = document.createElement('div');
    noteEl.className = 'note-item';
    noteEl.innerHTML = `
      <div>${note.text}</div>
      <div class="note-actions">
        <button class="btn" data-note-id="${note.id}" data-action="delete-note">
          <span class="material-icons">delete</span>
        </button>
      </div>
    `;
    
    notesContainer.appendChild(noteEl);
  });
}

// Get narrator notes
function getNarratorNotes(narratorId) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.NOTES], 'readonly');
    const store = transaction.objectStore(STORES.NOTES);
    const index = store.index('narrator_id');
    const request = index.getAll(narratorId);
    
    request.onsuccess = event => {
      resolve(event.target.result || []);
    };
    
    request.onerror = event => {
      console.error('Error getting notes:', event.target.error);
      resolve([]);
    };
  });
}

// Setup event listeners
function setupEventListeners() {
  // Language toggle
  document.getElementById('language-toggle').addEventListener('change', async e => {
    currentLanguage = e.target.checked ? 'en' : 'ur';
    document.getElementById('settings-language-toggle').checked = e.target.checked;
    await saveSetting('language', currentLanguage);
    applyLanguageAndTheme();
  });
  
  document.getElementById('settings-language-toggle').addEventListener('change', async e => {
    currentLanguage = e.target.checked ? 'en' : 'ur';
    document.getElementById('language-toggle').checked = e.target.checked;
    await saveSetting('language', currentLanguage);
    applyLanguageAndTheme();
  });
  
  // Theme toggle
  document.getElementById('theme-toggle').addEventListener('change', async e => {
    currentTheme = e.target.checked ? 'dark' : 'light';
    document.getElementById('settings-theme-toggle').checked = e.target.checked;
    await saveSetting('theme', currentTheme);
    applyLanguageAndTheme();
    
    // Regenerate visualizations if needed
    if (currentNarrator) {
      setTimeout(generateVisualizations, 100);
    }
  });
  
  document.getElementById('settings-theme-toggle').addEventListener('change', async e => {
    currentTheme = e.target.checked ? 'dark' : 'light';
    document.getElementById('theme-toggle').checked = e.target.checked;
    await saveSetting('theme', currentTheme);
    applyLanguageAndTheme();
    
    // Regenerate visualizations if needed
    if (currentNarrator) {
      setTimeout(generateVisualizations, 100);
    }
  });
  
  // Search with debounce
  let searchTimeout;
  const searchInput = document.getElementById('search-input');
  if (searchInput) {
    searchInput.addEventListener('keyup', e => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (e.key === 'Enter') {
          loadNarratorsList(1, getCurrentFilters());
        }
      }, 300); // 300ms debounce
    });
  }
  
  // Search button
  const searchBtn = document.getElementById('search-btn');
  if (searchBtn) {
    searchBtn.addEventListener('click', () => {
      loadNarratorsList(1, getCurrentFilters());
    });
  }
  
  // Filter selects
  document.querySelectorAll('select[id$="-filter"]').forEach(select => {
    select.addEventListener('change', () => {
      loadNarratorsList(1, getCurrentFilters());
    });
  });
  
  // Tabs
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      // Deactivate all tabs
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('active');
      });
      
      // Activate clicked tab
      tab.classList.add('active');
      
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      // Show selected tab content
      const tabId = tab.dataset.tab;
      const tabContent = document.getElementById(`${tabId}-tab`);
      if (tabContent) {
        tabContent.classList.remove('hidden');
      }
      
      // Generate visualizations if needed
      if (tabId === 'visualization' && currentNarrator) {
        setTimeout(generateVisualizations, 100);
      }
    });
  });
  
  // Visualization controls
  const treeViewBtn = document.getElementById('tree-view-btn');
  const graphViewBtn = document.getElementById('graph-view-btn');
  
  if (treeViewBtn) {
    treeViewBtn.addEventListener('click', () => {
      const treeViz = document.getElementById('tree-visualization');
      const graphViz = document.getElementById('graph-visualization');
      
      if (treeViz && graphViz) {
        treeViz.classList.remove('hidden');
        graphViz.classList.add('hidden');
      }
    });
  }
  
  if (graphViewBtn) {
    graphViewBtn.addEventListener('click', () => {
      const treeViz = document.getElementById('tree-visualization');
      const graphViz = document.getElementById('graph-visualization');
      
      if (treeViz && graphViz) {
        treeViz.classList.add('hidden');
        graphViz.classList.remove('hidden');
      }
    });
  }
  
  // Add note
  const saveNoteBtn = document.getElementById('save-note-btn');
  const noteInput = document.getElementById('note-input');
  
  if (saveNoteBtn && noteInput) {
    saveNoteBtn.addEventListener('click', async () => {
      if (!currentNarrator) return;
      
      const noteText = noteInput.value.trim();
      if (!noteText) return;
      
      try {
        await addNote(currentNarrator.scholar_indx, noteText);
        noteInput.value = '';
        await loadNarratorNotes();
      } catch (error) {
        console.error('Error adding note:', error);
        showError('Failed to add note. Please try again.');
      }
    });
  }
  
  // Delete note (event delegation)
  const notesContainer = document.getElementById('notes-container');
  if (notesContainer) {
    notesContainer.addEventListener('click', async e => {
      const deleteBtn = e.target.closest('[data-action="delete-note"]');
      if (!deleteBtn) return;
      
      const noteId = parseInt(deleteBtn.dataset.noteId, 10);
      if (isNaN(noteId)) return;
      
      try {
        await deleteNote(noteId);
        await loadNarratorNotes();
      } catch (error) {
        console.error('Error deleting note:', error);
        showError('Failed to delete note. Please try again.');
      }
    });
  }
  
  // Bookmark toggle
  const bookmarkBtn = document.getElementById('bookmark-btn');
  if (bookmarkBtn) {
    bookmarkBtn.addEventListener('click', async () => {
      if (!currentNarrator) return;
      
      try {
        const isBookmarked = await isNarratorBookmarked(currentNarrator.scholar_indx);
        
        if (isBookmarked) {
          await removeBookmark(currentNarrator.scholar_indx);
        } else {
          await addBookmark(currentNarrator.scholar_indx);
        }
        
        await updateBookmarkStatus();
      } catch (error) {
        console.error('Error toggling bookmark:', error);
        showError('Failed to update bookmark. Please try again.');
      }
    });
  }
  
  // Import/Export buttons
  const importBtn = document.getElementById('import-btn');
  const exportBtn = document.getElementById('export-btn');
  
  if (importBtn) {
    importBtn.addEventListener('click', () => {
      showModal('import-modal');
    });
  }
  
  if (exportBtn) {
    exportBtn.addEventListener('click', async () => {
      try {
        showLoader('Preparing data for export...');
        await exportData();
        hideLoader();
      } catch (error) {
        console.error('Export error:', error);
        showError('Failed to export data. Please try again.');
        hideLoader();
      }
    });
  }
  
  // Import file button
  const importFileBtn = document.getElementById('import-file-btn');
  if (importFileBtn) {
    importFileBtn.addEventListener('click', async () => {
      const fileInput = document.getElementById('import-file');
      if (!fileInput || !fileInput.files || !fileInput.files[0]) {
        showError('Please select a file to import.');
        return;
      }
      
      const file = fileInput.files[0];
      
      try {
        showLoader('Importing data...');
        
        if (file.name.endsWith('.csv')) {
          const csvText = await readFileAsText(file);
          await importCSVWithWorker(csvText);
        } else if (file.name.endsWith('.json')) {
          const jsonText = await readFileAsText(file);
          const data = JSON.parse(jsonText);
          await importFromJson(data);
        } else {
          throw new Error('Unsupported file format. Please use CSV or JSON.');
        }
        
        // Reload narrators into memory
        narrators = await getAllNarrators();
        
        // Repopulate filters and list
        populateFilterOptions();
        await loadNarratorsList();
        
        hideModal('import-modal');
        hideLoader();
        
        alert('Data imported successfully!');
      } catch (error) {
        console.error('Import error:', error);
        showError(`Import failed: ${error.message}`);
        hideLoader();
      }
    });
  }
  
  // Modal close buttons
  document.querySelectorAll('.modal-close').forEach(closeBtn => {
    closeBtn.addEventListener('click', () => {
      const modal = closeBtn.closest('.modal');
      if (modal) {
        hideModal(modal.id);
      }
    });
  });
  
  // Onboarding buttons
  const startAppBtn = document.getElementById('start-app-btn');
  if (startAppBtn) {
    startAppBtn.addEventListener('click', () => {
      hideModal('onboarding-modal');
      showModal('disclaimer-modal');
    });
  }
  
  const acceptDisclaimerBtn = document.getElementById('accept-disclaimer-btn');
  if (acceptDisclaimerBtn) {
    acceptDisclaimerBtn.addEventListener('click', async () => {
      await saveSetting('hasSeenOnboarding', true);
      hideModal('disclaimer-modal');
    });
  }
  
  // Category button
  const categoryBtn = document.getElementById('category-btn');
  if (categoryBtn) {
    categoryBtn.addEventListener('click', () => {
      if (currentNarrator) {
        showModal('category-modal');
      }
    });
  }
  
  // Settings button
  const settingsBtn = document.getElementById('settings-btn');
  if (settingsBtn) {
    settingsBtn.addEventListener('click', () => {
      showModal('settings-modal');
    });
  }
  
  // Reset data button
  const resetDataBtn = document.getElementById('reset-data-btn');
  if (resetDataBtn) {
    resetDataBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
        try {
          showLoader('Resetting data...');
          
          // Clear all stores
          await clearStore(STORES.NARRATORS);
          await clearStore(STORES.NOTES);
          await clearStore(STORES.BOOKMARKS);
          
          // Reimport data
          const response = await fetch('all_rawis.csv');
          if (!response.ok) throw new Error('Failed to fetch CSV file');
          
          const csvText = await response.text();
          await importCSVWithWorker(csvText);
          
          // Reload narrators into memory
          narrators = await getAllNarrators();
          
          // Repopulate filters and list
          populateFilterOptions();
          await loadNarratorsList();
          
          hideModal('settings-modal');
          hideLoader();
          
          alert('Data has been reset successfully!');
        } catch (error) {
          console.error('Reset error:', error);
          showError(`Reset failed: ${error.message}`);
          hideLoader();
        }
      }
    });
  }
}

// Add a note
function addNote(narratorId, text) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.NOTES], 'readwrite');
    const store = transaction.objectStore(STORES.NOTES);
    
    const note = {
      narrator_id: narratorId,
      text: text,
      date: new Date().toISOString()
    };
    
    const request = store.add(note);
    
    request.onsuccess = event => resolve(event.target.result);
    request.onerror = event => reject(event.target.error);
  });
}

// Delete a note
function deleteNote(noteId) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.NOTES], 'readwrite');
    const store = transaction.objectStore(STORES.NOTES);
    const request = store.delete(noteId);
    
    request.onsuccess = () => resolve();
    request.onerror = event => reject(event.target.error);
  });
}

// Add a bookmark
function addBookmark(narratorId) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.BOOKMARKS], 'readwrite');
    const store = transaction.objectStore(STORES.BOOKMARKS);
    
    const bookmark = {
      narrator_id: narratorId,
      date: new Date().toISOString()
    };
    
    const request = store.put(bookmark);
    
    request.onsuccess = () => resolve();
    request.onerror = event => reject(event.target.error);
  });
}

// Remove a bookmark
function removeBookmark(narratorId) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.BOOKMARKS], 'readwrite');
    const store = transaction.objectStore(STORES.BOOKMARKS);
    const request = store.delete(narratorId);
    
    request.onsuccess = () => resolve();
    request.onerror = event => reject(event.target.error);
  });
}

// Export data
async function exportData() {
  // Get all notes
  const notes = await getAllNotes();
  
  // Get all bookmarks
  const bookmarks = await getAllBookmarks();
  
  // Create export object
  const exportData = {
    narrators,
    notes,
    bookmarks,
    exportDate: new Date().toISOString(),
    version: DB_VERSION
  };
  
  // Convert to JSON
  const json = JSON.stringify(exportData);
  
  // Create download link
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `isnad_narrators_export_${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Import from JSON
async function importFromJson(data) {
  if (!data.narrators || !Array.isArray(data.narrators)) {
    throw new Error('Invalid JSON format: narrators array is missing');
  }
  
  // Clear existing data
  await clearStore(STORES.NARRATORS);
  await clearStore(STORES.NOTES);
  await clearStore(STORES.BOOKMARKS);
  
  // Import narrators in chunks
  const chunkSize = 100;
  for (let i = 0; i < data.narrators.length; i += chunkSize) {
    const chunk = data.narrators.slice(i, i + chunkSize);
    await saveNarrators(chunk);
    updateLoader(`Importing narrators ${i + chunk.length}/${data.narrators.length}...`);
    await new Promise(resolve => setTimeout(resolve, 0)); // Yield to UI
  }
  
  // Import notes if present
  if (data.notes && Array.isArray(data.notes)) {
    for (let i = 0; i < data.notes.length; i += chunkSize) {
      const chunk = data.notes.slice(i, i + chunkSize);
      await saveNotes(chunk);
      updateLoader(`Importing notes ${i + chunk.length}/${data.notes.length}...`);
      await new Promise(resolve => setTimeout(resolve, 0)); // Yield to UI
    }
  }
  
  // Import bookmarks if present
  if (data.bookmarks && Array.isArray(data.bookmarks)) {
    for (let i = 0; i < data.bookmarks.length; i += chunkSize) {
      const chunk = data.bookmarks.slice(i, i + chunkSize);
      await saveBookmarks(chunk);
      updateLoader(`Importing bookmarks ${i + chunk.length}/${data.bookmarks.length}...`);
      await new Promise(resolve => setTimeout(resolve, 0)); // Yield to UI
    }
  }
  
  return true;
}

// Get all notes
function getAllNotes() {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.NOTES], 'readonly');
    const store = transaction.objectStore(STORES.NOTES);
    const request = store.getAll();
    
    request.onsuccess = event => resolve(event.target.result);
    request.onerror = event => reject(event.target.error);
  });
}

// Get all bookmarks
function getAllBookmarks() {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([STORES.BOOKMARKS], 'readonly');
    const store = transaction.objectStore(STORES.BOOKMARKS);
    const request = store.getAll();
    
    request.onsuccess = event => resolve(event.target.result);
    request.onerror = event => reject(event.target.error);
  });
}

// Clear a store
function clearStore(storeName) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    
    const transaction = db.transaction([storeName], 'readwrite');
    const store = transaction.objectStore(storeName);
    const request = store.clear();
    
    request.onsuccess = () => resolve();
    request.onerror = event => reject(event.target.error);
  });
}

// Save notes to database
function saveNotes(notes) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    if (!notes || notes.length === 0) return resolve();
    
    const transaction = db.transaction([STORES.NOTES], 'readwrite');
    const store = transaction.objectStore(STORES.NOTES);
    
    // Track completion
    let completed = 0;
    
    // Add each note
    notes.forEach(note => {
      const request = store.add(note);
      
      request.onsuccess = () => {
        completed++;
        if (completed === notes.length) resolve();
      };
      
      request.onerror = event => {
        console.error('Error saving note:', event.target.error);
        completed++;
        if (completed === notes.length) resolve();
      };
    });
    
    // Handle transaction errors
    transaction.onerror = event => reject(event.target.error);
  });
}

// Save bookmarks to database
function saveBookmarks(bookmarks) {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error('Database not initialized'));
    if (!bookmarks || bookmarks.length === 0) return resolve();
    
    const transaction = db.transaction([STORES.BOOKMARKS], 'readwrite');
    const store = transaction.objectStore(STORES.BOOKMARKS);
    
    // Track completion
    let completed = 0;
    
    // Add each bookmark
    bookmarks.forEach(bookmark => {
      const request = store.put(bookmark);
      
      request.onsuccess = () => {
        completed++;
        if (completed === bookmarks.length) resolve();
      };
      
      request.onerror = event => {
        console.error('Error saving bookmark:', event.target.error);
        completed++;
        if (completed === bookmarks.length) resolve();
      };
    });
    
    // Handle transaction errors
    transaction.onerror = event => reject(event.target.error);
  });
}

// Read file as text
function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = event => {
      resolve(event.target.result);
    };
    
    reader.onerror = error => {
      reject(error);
    };
    
    reader.readAsText(file);
  });
}

// Show onboarding modal
function showOnboarding() {
  showModal('onboarding-modal');
}

// Show modal
function showModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('active');
  }
}

// Hide modal
function hideModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('active');
  }
}

// Show loading indicator
function showLoader(message = 'Loading...') {
  isLoading = true;
  
  // Create loader if it doesn't exist
  if (!document.getElementById('app-loader')) {
    const loader = document.createElement('div');
    loader.id = 'app-loader';
    loader.innerHTML = `
      <div class="loader-content">
        <div class="spinner"></div>
        <div id="loader-message"></div>
      </div>
    `;
    document.body.appendChild(loader);
  }
  
  // Update message
  const messageEl = document.getElementById('loader-message');
  if (messageEl) {
    messageEl.innerText = message;
  }
  
  // Show loader
  document.getElementById('app-loader').style.display = 'flex';
}

// Update loader message
function updateLoader(message) {
  const messageEl = document.getElementById('loader-message');
  if (messageEl) {
    messageEl.innerText = message;
  }
}

// Hide loading indicator
function hideLoader() {
  isLoading = false;
  const loader = document.getElementById('app-loader');
  if (loader) {
    loader.style.display = 'none';
  }
}

// Show error message
function showError(message) {
  // Create error element if it doesn't exist
  if (!document.getElementById('app-error')) {
    const errorEl = document.createElement('div');
    errorEl.id = 'app-error';
    errorEl.innerHTML = `
      <div class="error-content">
        <div class="error-icon">⚠️</div>
        <div id="error-message"></div>
        <button id="error-close">OK</button>
      </div>
    `;
    document.body.appendChild(errorEl);
    
    // Add close handler
    document.getElementById('error-close').addEventListener('click', () => {
      document.getElementById('app-error').style.display = 'none';
    });
  }
  
  // Update message
  document.getElementById('error-message').innerText = message;
  
  // Show error
  document.getElementById('app-error').style.display = 'flex';
  
  // Auto-hide after 5 seconds
  setTimeout(() => {
    const errorEl = document.getElementById('app-error');
    if (errorEl && errorEl.style.display === 'flex') {
      errorEl.style.display = 'none';
    }
  }, 5000);
}

// Add these CSS styles to your existing styles
const additionalCSS = `
#app-loader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loader-content {
  background-color: var(--card-bg);
  padding: 2rem;
  border-radius: var(--border-radius);
  text-align: center;
  box-shadow: var(--shadow);
}

.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(0,0,0,0.1);
  border-radius: 50%;
  border-top-color: var(--primary);
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#app-error {
  position: fixed;
  top: 1rem;
  right: 1rem;
  background-color: var(--error);
  color: white;
  padding: 1rem;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  max-width: 300px;
  display: none;
  z-index: 9998;
}

.error-content {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.error-icon {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

#error-close {
  margin-top: 1rem;
  background-color: white;
  color: var(--error);
  border: none;
  border-radius: var(--border-radius);
  padding: 0.5rem 1rem;
  cursor: pointer;
  font-weight: bold;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
margin-top: 1rem;
gap: 1rem;
}

.pagination-btn {
min-width: 40px;
height: 40px;
display: flex;
justify-content: center;
align-items: center;
background-color: var(--primary);
color: white;
border: none;
border-radius: var(--border-radius);
cursor: pointer;
}

.pagination-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.page-info {
font-size: 0.9rem;
}

/* Fix font loading issues */
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans&family=Noto+Nastaliq+Urdu&display=swap');

/* Ensure material icons work */
.material-icons {
font-family: 'Material Icons';
font-weight: normal;
font-style: normal;
font-size: 24px;
display: inline-block;
line-height: 1;
text-transform: none;
letter-spacing: normal;
word-wrap: normal;
white-space: nowrap;
direction: ltr;
}
`;

// Add the CSS to the page
document.addEventListener('DOMContentLoaded', () => {
const styleEl = document.createElement('style');
styleEl.textContent = additionalCSS;
document.head.appendChild(styleEl);

// Add Material Icons font if needed
if (!document.querySelector('link[href*="Material+Icons"]')) {
const link = document.createElement('link');
link.rel = 'stylesheet';
link.href = 'https://fonts.googleapis.com/icon?family=Material+Icons';
document.head.appendChild(link);
}
});




// Add zoom in/out controls for visualizations
document.addEventListener('DOMContentLoaded', function() {
// Create zoom controls container
const zoomControls = document.createElement('div');
zoomControls.className = 'zoom-controls';
zoomControls.innerHTML = `    <button id="zoom-in" class="btn zoom-btn" title="Zoom In">       <span class="material-icons">add</span>     </button>     <button id="zoom-reset" class="btn zoom-btn" title="Reset Zoom">       <span class="material-icons">refresh</span>     </button>     <button id="zoom-out" class="btn zoom-btn" title="Zoom Out">       <span class="material-icons">remove</span>     </button>  `;

// Add styles for zoom controls
const style = document.createElement('style');
style.textContent = `
.zoom-controls {
position: absolute;
bottom: 10px;
right: 10px;
display: flex;
gap: 5px;
background: rgba(255, 255, 255, 0.7);
padding: 5px;
border-radius: var(--border-radius);
z-index: 10;
}

    .dark-theme .zoom-controls {
      background: rgba(30, 30, 30, 0.7);
    }
    
    .zoom-btn {
      width: 36px;
      height: 36px;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .visualization {
      position: relative;
      overflow: hidden;
    }
    
    .visualization svg {
      transform-origin: center;
      transition: transform 0.2s ease-out;
    }
    
    .panning svg {
      transition: none;
    }
    `;
document.head.appendChild(style);

// Wait for visualization tab to be available
const checkVisualizationTab = setInterval(() => {
const visualizationTab = document.getElementById('visualization-tab');
if (visualizationTab) {
clearInterval(checkVisualizationTab);

      // Add zoom controls to visualization containers
      const treeViz = document.getElementById('tree-visualization');
      const graphViz = document.getElementById('graph-visualization');
      
      if (treeViz) {
        treeViz.parentNode.style.position = 'relative';
        const treeZoomControls = zoomControls.cloneNode(true);
        treeZoomControls.id = 'tree-zoom-controls';
        treeViz.parentNode.appendChild(treeZoomControls);
        setupZoomControls(treeZoomControls, treeViz);
      }
      
      if (graphViz) {
        graphViz.parentNode.style.position = 'relative';
        const graphZoomControls = zoomControls.cloneNode(true);
        graphZoomControls.id = 'graph-zoom-controls';
        graphViz.parentNode.appendChild(graphZoomControls);
        setupZoomControls(graphZoomControls, graphViz);
      }
    }
    }, 500);

// Set up zoom functionality for a visualization container
function setupZoomControls(controlsContainer, vizContainer) {
const zoomInBtn = controlsContainer.querySelector('[id^="zoom-in"]');
const zoomResetBtn = controlsContainer.querySelector('[id^="zoom-reset"]');
const zoomOutBtn = controlsContainer.querySelector('[id^="zoom-out"]');

    // Initialize zoom level
    let zoomLevel = 1;
    let panStartX = 0;
    let panStartY = 0;
    let translateX = 0;
    let translateY = 0;
    let isPanning = false;
    
    // Zoom in button
    zoomInBtn.addEventListener('click', () => {
      zoomLevel = Math.min(zoomLevel + 0.2, 3);
      updateTransform();
    });
    
    // Zoom reset button
    zoomResetBtn.addEventListener('click', () => {
      zoomLevel = 1;
      translateX = 0;
      translateY = 0;
      updateTransform();
    });
    
    // Zoom out button
    zoomOutBtn.addEventListener('click', () => {
      zoomLevel = Math.max(zoomLevel - 0.2, 0.5);
      updateTransform();
    });
    
    // Add wheel zoom support
    vizContainer.addEventListener('wheel', (e) => {
      e.preventDefault();
      
      // Get mouse position relative to visualization
      const rect = vizContainer.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      // Calculate zoom
      const zoomDelta = e.deltaY > 0 ? -0.1 : 0.1;
      const newZoomLevel = Math.max(0.5, Math.min(3, zoomLevel + zoomDelta));
      
      // Adjust translation to zoom toward mouse position
      if (zoomLevel !== newZoomLevel) {
        const scale = newZoomLevel / zoomLevel;
        translateX = mouseX - scale * (mouseX - translateX);
        translateY = mouseY - scale * (mouseY - translateY);
        zoomLevel = newZoomLevel;
        updateTransform();
      }
    });
    
    // Add panning support with mouse drag
    vizContainer.addEventListener('mousedown', (e) => {
      if (e.button === 0) { // Left mouse button
        isPanning = true;
        vizContainer.classList.add('panning');
        panStartX = e.clientX - translateX;
        panStartY = e.clientY - translateY;
        
        // Create overlay for drag handling
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.cursor = 'grabbing';
        overlay.style.zIndex = '1000';
        overlay.style.userSelect = 'none';
        document.body.appendChild(overlay);
        
        function handleMouseMove(e) {
          if (isPanning) {
            translateX = e.clientX - panStartX;
            translateY = e.clientY - panStartY;
            updateTransform();
          }
        }
        
        function handleMouseUp() {
          isPanning = false;
          vizContainer.classList.remove('panning');
          document.body.removeChild(overlay);
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        }
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      }
    });
    
    // Update SVG transform
    function updateTransform() {
      const svg = vizContainer.querySelector('svg');
      if (svg) {
        svg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`;
      }
    }
    
    // Add grab cursor
    vizContainer.style.cursor = 'grab';
    }

// Add a MutationObserver to handle dynamically created visualization content
const vizObserver = new MutationObserver((mutations) => {
mutations.forEach(mutation => {
if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
mutation.addedNodes.forEach(node => {
if (node.nodeName === 'SVG') {
// Set initial transform
node.style.transformOrigin = 'center';
node.style.transition = 'transform 0.2s ease-out';
}
});
}
});
});

// Observe both visualization containers once they're available
const observeVizContainers = setInterval(() => {
const treeViz = document.getElementById('tree-visualization');
const graphViz = document.getElementById('graph-visualization');

    if (treeViz) {
      vizObserver.observe(treeViz, { childList: true });
      clearInterval(observeVizContainers);
    }
    
    if (graphViz) {
      vizObserver.observe(graphViz, { childList: true });
      clearInterval(observeVizContainers);
    }
    }, 500);

// Handle visualization tab activation to ensure zoom controls are visible
document.addEventListener('click', (e) => {
if (e.target.classList.contains('tab') && e.target.dataset.tab === 'visualization') {
setTimeout(() => {
const treeZoomControls = document.getElementById('tree-zoom-controls');
const graphZoomControls = document.getElementById('graph-zoom-controls');

        if (treeZoomControls) {
          treeZoomControls.style.display = document.getElementById('tree-visualization').classList.contains('hidden') ? 'none' : 'flex';
        }
        
        if (graphZoomControls) {
          graphZoomControls.style.display = document.getElementById('graph-visualization').classList.contains('hidden') ? 'none' : 'flex';
        }
      }, 100);
    }
    });

// Also handle tree/graph view button clicks
document.addEventListener('click', (e) => {
const treeViewBtn = e.target.closest('\#tree-view-btn');
const graphViewBtn = e.target.closest('\#graph-view-btn');

    if (treeViewBtn) {
      setTimeout(() => {
        const treeZoomControls = document.getElementById('tree-zoom-controls');
        const graphZoomControls = document.getElementById('graph-zoom-controls');
        if (treeZoomControls) treeZoomControls.style.display = 'flex';
        if (graphZoomControls) graphZoomControls.style.display = 'none';
      }, 100);
    }
    
    if (graphViewBtn) {
      setTimeout(() => {
        const treeZoomControls = document.getElementById('tree-zoom-controls');
        const graphZoomControls = document.getElementById('graph-zoom-controls');
        if (treeZoomControls) treeZoomControls.style.display = 'none';
        if (graphZoomControls) graphZoomControls.style.display = 'flex';
      }, 100);
    }
    });
});


</script>
</body>
</html>
