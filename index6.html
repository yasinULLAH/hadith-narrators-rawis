
<!DOCTYPE html>
<html lang="ur" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Isnad Narrators Explorer</title>
  <style>
    :root {
      --primary: #1e88e5;
      --secondary: #26c6da;
      --dark: #212121;
      --light: #f5f5f5;
      --success: #43a047;
      --warning: #ffa000;
      --error: #e53935;
      --text-dark: #212121;
      --text-light: #f5f5f5;
      --bg-dark: #121212;
      --bg-light: #ffffff;
      --border-radius: 8px;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    
    .dark-theme {
      --primary: #42a5f5;
      --secondary: #4dd0e1;
      --bg-color: var(--bg-dark);
      --text-color: var(--text-light);
      --card-bg: #1e1e1e;
      --border-color: #333;
    }
    
    .light-theme {
      --primary: #1976d2;
      --secondary: #00acc1;
      --bg-color: var(--bg-light);
      --text-color: var(--text-dark);
      --card-bg: #ffffff;
      --border-color: #e0e0e0;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: var(--transition);
    }
    
    body {
      font-family: 'Noto Sans', 'Noto Nastaliq Urdu', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background-color: var(--primary);
      color: white;
      border-radius: var(--border-radius);
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }
    
    .header-title {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .header-controls {
      display: flex;
      gap: 1rem;
    }
    
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--secondary);
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: var(--transition);
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .btn-primary {
      background-color: var(--primary);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
    }
    
    .btn-success {
      background-color: var(--success);
    }
    
    .btn-warning {
      background-color: var(--warning);
    }
    
    .btn-error {
      background-color: var(--error);
    }
    
    .search-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .search-input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    
    .filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
      padding: 1rem;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 3fr;
      gap: 2rem;
    }
    
    .narrator-list {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 1rem;
      box-shadow: var(--shadow);
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .narrator-item {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: var(--border-radius);
      background-color: rgba(0,0,0,0.05);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .narrator-item:hover {
      background-color: var(--primary);
      color: white;
    }
    
    .narrator-item.active {
      background-color: var(--primary);
      color: white;
    }
    
    .narrator-detail {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }
    
    .narrator-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .narrator-name {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .narrator-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .narrator-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    
    .info-group {
      margin-bottom: 1rem;
    }
    
    .info-label {
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }
    
    .info-value {
      padding: 0.5rem;
      background-color: rgba(0,0,0,0.05);
      border-radius: var(--border-radius);
    }
    
    .tabs {
      display: flex;
      margin-top: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
    }
    
    .tab.active {
      border-bottom: 3px solid var(--primary);
      font-weight: bold;
    }
    
    .tab-content {
      padding: 1.5rem 0;
    }
    
    .visualization {
      height: 400px;
      background-color: rgba(0,0,0,0.05);
      border-radius: var(--border-radius);
      margin-top: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    
    .tree-viz, .graph-viz {
      width: 100%;
      height: 100%;
    }
    
    .notes-container {
      margin-top: 1rem;
    }
    
    .note-item {
      padding: 0.75rem;
      background-color: rgba(0,0,0,0.05);
      border-radius: var(--border-radius);
      margin-bottom: 0.5rem;
    }
    
    .note-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: var(--shadow);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      cursor: pointer;
      font-size: 1.5rem;
    }
    
    .modal-title {
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .onboarding {
      text-align: center;
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .onboarding-icon {
      font-size: 4rem;
      color: var(--primary);
      margin-bottom: 2rem;
    }
    
    .onboarding-title {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    
    .onboarding-text {
      margin-bottom: 2rem;
    }
    
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .toggle {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--primary);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    .fade-in {
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }
    
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    
    .slide-in {
      transform: translateX(30px);
      opacity: 0;
      animation: slideIn 0.5s forwards;
    }
    
    @keyframes slideIn {
      to { 
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .rotate {
      animation: rotate 1s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .narrator-info {
        grid-template-columns: 1fr;
      }
      
      .header-title {
        font-size: 1.2rem;
      }
      
      .header-controls {
        flex-wrap: wrap;
      }
    }
    
    @font-face {
      font-family: 'Noto Nastaliq Urdu';
      src: url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap');
    }
    
    @font-face {
      font-family: 'Noto Sans';
      src: url('https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap');
    }
    
    .material-icons {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
    }
  </style>
</head>
<body class="light-theme">

  <div class="container">
    <header>
      <div class="header-title">
        <span class="en">Isnad Narrators Explorer</span>
        <span class="ur">اسناد راویوں کا استکشاف</span>
      </div>
      <div class="header-controls">
        <div class="toggle-container">
          <span class="ur">اردو</span>
          <label class="toggle">
            <input type="checkbox" id="language-toggle">
            <span class="toggle-slider"></span>
          </label>
          <span class="en">English</span>
        </div>
        <div class="toggle-container">
          <span class="material-icons">light_mode</span>
          <label class="toggle">
            <input type="checkbox" id="theme-toggle">
            <span class="toggle-slider"></span>
          </label>
          <span class="material-icons">dark_mode</span>
        </div>
        <button class="btn btn-primary" id="import-btn">
          <span class="en">Import</span>
          <span class="ur">درآمد کریں</span>
        </button>
        <button class="btn btn-secondary" id="export-btn">
          <span class="en">Export</span>
          <span class="ur">برآمد کریں</span>
        </button>
        <button class="btn" id="settings-btn">
          <span class="material-icons">settings</span>
        </button>
      </div>
    </header>
    
    <div class="search-container">
      <input type="text" id="search-input" class="search-input" placeholder="Search narrators...">
      <button class="btn btn-primary" id="search-btn">
        <span class="material-icons">search</span>
      </button>
    </div>
    
    <div class="filter-container">
      <div class="filter-group">
        <div class="filter-title">
          <span class="en">Generation</span>
          <span class="ur">نسل</span>
        </div>
        <select id="generation-filter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-title">
          <span class="en">Area of Interest</span>
          <span class="ur">دلچسپی کا شعبہ</span>
        </div>
        <select id="interest-filter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-title">
          <span class="en">Tags</span>
          <span class="ur">ٹیگز</span>
        </div>
        <select id="tag-filter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-title">
          <span class="en">Category</span>
          <span class="ur">زمرہ</span>
        </div>
        <select id="category-filter">
          <option value="">All</option>
        </select>
      </div>
    </div>
    
    <div class="main-content">
      <div class="narrator-list" id="narrator-list">
        <!-- Narrator list items will be populated here -->
      </div>
      
      <div class="narrator-detail" id="narrator-detail">
        <div class="narrator-placeholder">
          <p class="en">Select a narrator to view details</p>
          <p class="ur">تفصیلات دیکھنے کے لئے راوی منتخب کریں</p>
        </div>
        
        <div class="narrator-content hidden">
          <div class="narrator-header">
            <h2 class="narrator-name" id="narrator-name"></h2>
            <div class="narrator-actions">
              <button class="btn" id="bookmark-btn">
                <span class="material-icons">bookmark_border</span>
              </button>
              <button class="btn" id="category-btn">
                <span class="material-icons">category</span>
              </button>
              <button class="btn" id="note-btn">
                <span class="material-icons">note_add</span>
              </button>
            </div>
          </div>
          
          <div class="narrator-info">
            <div class="info-group">
              <div class="info-label">
                <span class="en">Grade</span>
                <span class="ur">درجہ</span>
              </div>
              <div class="info-value" id="narrator-grade"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Birth</span>
                <span class="ur">پیدائش</span>
              </div>
              <div class="info-value" id="narrator-birth"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Death</span>
                <span class="ur">وفات</span>
              </div>
              <div class="info-value" id="narrator-death"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Places of Stay</span>
                <span class="ur">قیام کی جگہیں</span>
              </div>
              <div class="info-value" id="narrator-places"></div>
            </div>
          </div>
          
          <div class="tabs">
            <div class="tab active" data-tab="relations">
              <span class="en">Relations</span>
              <span class="ur">تعلقات</span>
            </div>
            <div class="tab" data-tab="visualization">
              <span class="en">Visualization</span>
              <span class="ur">بصری تجسیم</span>
            </div>
            <div class="tab" data-tab="notes">
              <span class="en">Notes</span>
              <span class="ur">نوٹس</span>
            </div>
          </div>
          
          <div class="tab-content" id="relations-tab">
            <div class="info-group">
              <div class="info-label">
                <span class="en">Parents</span>
                <span class="ur">والدین</span>
              </div>
              <div class="info-value" id="narrator-parents"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Spouse</span>
                <span class="ur">شریک حیات</span>
              </div>
              <div class="info-value" id="narrator-spouse"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Siblings</span>
                <span class="ur">بہن بھائی</span>
              </div>
              <div class="info-value" id="narrator-siblings"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Children</span>
                <span class="ur">اولاد</span>
              </div>
              <div class="info-value" id="narrator-children"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Teachers</span>
                <span class="ur">استاد</span>
              </div>
              <div class="info-value" id="narrator-teachers"></div>
            </div>
            
            <div class="info-group">
              <div class="info-label">
                <span class="en">Students</span>
                <span class="ur">طلبا</span>
              </div>
              <div class="info-value" id="narrator-students"></div>
            </div>
          </div>
          
          <div class="tab-content hidden" id="visualization-tab">
            <div class="visualization">
              <div class="tree-viz" id="tree-visualization"></div>
              <div class="graph-viz hidden" id="graph-visualization"></div>
              
              <div class="viz-controls">
                <button class="btn" id="tree-view-btn">
                  <span class="en">Tree View</span>
                  <span class="ur">درخت نظارہ</span>
                </button>
                <button class="btn" id="graph-view-btn">
                  <span class="en">Graph View</span>
                  <span class="ur">گراف نظارہ</span>
                </button>
              </div>
            </div>
          </div>
          
          <div class="tab-content hidden" id="notes-tab">
            <textarea id="note-input" class="note-input" placeholder="Add a new note..."></textarea>
            <button class="btn btn-primary" id="save-note-btn">
              <span class="en">Save Note</span>
              <span class="ur">نوٹ محفوظ کریں</span>
            </button>
            
            <div class="notes-container" id="notes-container">
              <!-- Notes will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>

<!-- Modals -->

  <div class="modal" id="onboarding-modal">
    <div class="modal-content">
      <span class="modal-close" id="onboarding-close">&times;</span>
      <div class="onboarding">
        <div class="onboarding-icon">📚</div>
        <h1 class="onboarding-title">
          <span class="en">Welcome to Isnad Narrators Explorer</span>
          <span class="ur">اسناد راویوں کے استکشاف میں خوش آمدید</span>
        </h1>
        <p class="onboarding-text">
          <span class="en">This application helps you explore and understand the relationships between narrators in Islamic tradition. Search, filter, and visualize narrator connections, add your own notes, and more.</span>
          <span class="ur">یہ ایپلیکیشن آپ کو اسلامی روایت میں راویوں کے درمیان تعلقات کو تلاش کرنے اور سمجھنے میں مدد کرتی ہے۔ راوی کنکشنز کو تلاش کریں، فلٹر کریں، اور ویژولائز کریں، اپنے نوٹس شامل کریں، اور بہت کچھ۔</span>
        </p>
        <button class="btn btn-primary" id="start-app-btn">
          <span class="en">Start Exploring</span>
          <span class="ur">دریافت شروع کریں</span>
        </button>
      </div>
    </div>
    </div>

  <div class="modal" id="disclaimer-modal">
    <div class="modal-content">
      <span class="modal-close" id="disclaimer-close">&times;</span>
      <h2 class="modal-title">
        <span class="en">Disclaimer</span>
        <span class="ur">دستبرداری</span>
      </h2>
      <p>
        <span class="en">
          This application provides information about narrators of Islamic traditions for educational purposes only. The data may not be complete or entirely accurate. Users are encouraged to verify information from authoritative sources.
        </span>
        <span class="ur">
          یہ ایپلیکیشن صرف تعلیمی مقاصد کے لیے اسلامی روایات کے راویوں کے بارے میں معلومات فراہم کرتی ہے۔ ڈیٹا مکمل یا مکمل طور پر درست نہیں ہو سکتا ہے۔ صارفین کو مستند ذرائع سے معلومات کی تصدیق کرنے کی ترغیب دی جاتی ہے۔
        </span>
      </p>
      <button class="btn btn-primary mt-4" id="accept-disclaimer-btn">
        <span class="en">I Understand</span>
        <span class="ur">میں سمجھتا ہوں</span>
      </button>
    </div>
</div>

  <div class="modal" id="category-modal">
    <div class="modal-content">
      <span class="modal-close" id="category-modal-close">&times;</span>
      <h2 class="modal-title">
        <span class="en">Manage Categories</span>
        <span class="ur">زمرہ جات کا انتظام کریں</span>
      </h2>
      <div id="categories-list">
        <!-- Categories will be populated here -->
      </div>
      <div class="mt-4">
        <input type="text" id="new-category-input" class="search-input" placeholder="New category name">
        <button class="btn btn-primary" id="add-category-btn">
          <span class="en">Add Category</span>
          <span class="ur">زمرہ شامل کریں</span>
        </button>
      </div>
      <div class="mt-4">
        <button class="btn" id="assign-category-btn">
          <span class="en">Assign Selected</span>
          <span class="ur">منتخب کردہ تفویض کریں</span>
        </button>
      </div>
    </div>
    </div>

  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <span class="modal-close" id="settings-modal-close">&times;</span>
      <h2 class="modal-title">
        <span class="en">Settings</span>
        <span class="ur">ترتیبات</span>
      </h2>
      <div class="setting-group">
        <h3>
          <span class="en">Language</span>
          <span class="ur">زبان</span>
        </h3>
        <div class="toggle-container">
          <span class="ur">اردو</span>
          <label class="toggle">
            <input type="checkbox" id="settings-language-toggle">
            <span class="toggle-slider"></span>
          </label>
          <span class="en">English</span>
        </div>
      </div>
      <div class="setting-group">
        <h3>
          <span class="en">Theme</span>
          <span class="ur">تھیم</span>
        </h3>
        <div class="toggle-container">
          <span class="material-icons">light_mode</span>
          <label class="toggle">
            <input type="checkbox" id="settings-theme-toggle">
            <span class="toggle-slider"></span>
          </label>
          <span class="material-icons">dark_mode</span>
        </div>
      </div>
      <div class="setting-group">
        <h3>
          <span class="en">Reset Data</span>
          <span class="ur">ڈیٹا ری سیٹ کریں</span>
        </h3>
        <button class="btn btn-error" id="reset-data-btn">
          <span class="en">Reset All Data</span>
          <span class="ur">تمام ڈیٹا ری سیٹ کریں</span>
        </button>
      </div>
      <div class="setting-group">
        <h3>
          <span class="en">About</span>
          <span class="ur">ہمارے بارے میں</span>
        </h3>
        <p>
          <span class="en">Isnad Narrators Explorer v1.0</span>
          <span class="ur">اسناد راویوں کا استکشاف v1.0</span>
        </p>
      </div>
    </div>
    </div>

  <div class="modal" id="import-modal">
    <div class="modal-content">
      <span class="modal-close" id="import-modal-close">&times;</span>
      <h2 class="modal-title">
        <span class="en">Import Data</span>
        <span class="ur">ڈیٹا درآمد کریں</span>
      </h2>
      <p>
        <span class="en">Import narrator data from CSV or JSON file.</span>
        <span class="ur">CSV یا JSON فائل سے راوی ڈیٹا درآمد کریں۔</span>
      </p>
      <input type="file" id="import-file" accept=".csv,.json">
      <button class="btn btn-primary mt-4" id="import-file-btn">
        <span class="en">Import</span>
        <span class="ur">درآمد کریں</span>
      </button>
    </div>
</div>

  <div class="modal" id="export-modal">
    <div class="modal-content">
      <span class="modal-close" id="export-modal-close">&times;</span>
      <h2 class="modal-title">
        <span class="en">Export Data</span>
        <span class="ur">ڈیٹا برآمد کریں</span>
      </h2>
      <p>
        <span class="en">Export all data including narrators, notes, bookmarks, and categories.</span>
        <span class="ur">راویوں، نوٹس، بک مارکس، اور زمرہ جات سمیت تمام ڈیٹا برآمد کریں۔</span>
      </p>
      <button class="btn btn-primary mt-4" id="export-file-btn">
        <span class="en">Export as JSON</span>
        <span class="ur">JSON کے طور پر برآمد کریں</span>
      </button>
    </div>
</div>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&family=Noto+Sans&display=swap" rel="stylesheet">
<script>
// DB and UI constants
const DB_NAME = 'IsnadNarratorsDB';
const DB_VERSION = 1;
const NARRATORS_STORE = 'narrators';
const NOTES_STORE = 'notes';
const BOOKMARKS_STORE = 'bookmarks';
const CATEGORIES_STORE = 'categories';
const SETTINGS_STORE = 'settings';
const ITEMS_PER_PAGE = 20;

// State variables
let db;
let currentNarrator = null;
let currentLanguage = 'en';
let currentTheme = 'light';
let currentPage = 1;
let totalNarrators = 0;
let currentFilter = {};

// Initialize the application
document.addEventListener('DOMContentLoaded', init);

// Append progress modal to document
const importProgressModalHTML = `

  
    
      Importing Narrator Data
      راوی ڈیٹا درآمد کر رہا ہے
    
    
      Please wait while we import the narrator data. This may take a few moments...
      براہ کرم انتظار کریں جب تک ہم راوی ڈیٹا درآمد کر رہے ہیں۔ اس میں کچھ لمحات لگ سکتے ہیں...
    
    
      
    
    
      0%
    
  
`;

document.body.insertAdjacentHTML('beforeend', importProgressModalHTML);

// Add loading CSS to existing styles
const loadingCSS = `
#app-loading-indicator {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.7);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: var(--primary);
  animation: spin 1s ease-in-out infinite;
}

.loading-text {
  margin-top: 20px;
  color: white;
  font-size: 18px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.progress-container {
  width: 100%;
  height: 20px;
  background-color: #e0e0e0;
  border-radius: 10px;
  margin: 20px 0;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  background-color: var(--primary);
  width: 0;
  transition: width 0.3s ease;
}

.progress-text {
  text-align: center;
  font-weight: bold;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 1.5rem;
  padding: 0.5rem;
  gap: 1rem;
}

.pagination-btn {
  min-width: 40px;
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.page-info {
  font-size: 0.9rem;
  color: var(--text-color);
}

.loading {
  text-align: center;
  padding: 2rem;
  color: var(--primary);
  font-weight: bold;
}
`;

document.querySelector('style').textContent += loadingCSS;

// Initialize app
async function init() {
  await initDB();
  await loadSettings();
  updateLanguageDisplay();
  updateThemeDisplay();
  
  // Show loading indicator
  showLoadingIndicator();
  
  // Check if it's the first run
  const hasCompletedOnboarding = await getSettingValue('hasCompletedOnboarding');
  
  // Check if we need to import data
  const hasImportedData = await getSettingValue('hasImportedData');
  if (!hasImportedData) {
    // Show progress modal instead of trying to import all at once
    showModal('import-progress-modal');
    
    try {
      // Start the import process in chunks
      const response = await fetch('all_rawis.csv');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const csvData = await response.text();
      await importCSVDataProgressively(csvData);
      await updateSetting('hasImportedData', true);
      hideModal('import-progress-modal');
    } catch (error) {
      console.error('Error loading CSV file:', error);
      alert('Failed to load narrator data. Please try refreshing the page.');
      hideModal('import-progress-modal');
    }
  }
  
  // Load the first page of narrators
  await populateNarratorsList({}, 1);
  
  // Initialize filters after the first page is loaded
  // This prevents hanging by not processing all data at once
  setTimeout(async () => {
    await populateFilters();
    hideLoadingIndicator();
    
    // Show onboarding only after data is loaded
    if (!hasCompletedOnboarding) {
      showModal('onboarding-modal');
    }
  }, 100);
  
  // Set up event listeners
  setupEventListeners();
}

// Database initialization
async function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onupgradeneeded = (event) => {
      db = event.target.result;
      
      // Create object stores if they don't exist
      if (!db.objectStoreNames.contains(NARRATORS_STORE)) {
        const narratorsStore = db.createObjectStore(NARRATORS_STORE, { keyPath: 'scholar_indx' });
        narratorsStore.createIndex('name', 'name', { unique: false });
        narratorsStore.createIndex('grade', 'grade', { unique: false });
        narratorsStore.createIndex('tags', 'tags', { unique: false, multiEntry: true });
      }
      
      if (!db.objectStoreNames.contains(NOTES_STORE)) {
        const notesStore = db.createObjectStore(NOTES_STORE, { keyPath: 'id', autoIncrement: true });
        notesStore.createIndex('narrator_id', 'narrator_id', { unique: false });
      }
      
      if (!db.objectStoreNames.contains(BOOKMARKS_STORE)) {
        db.createObjectStore(BOOKMARKS_STORE, { keyPath: 'narrator_id' });
      }
      
      if (!db.objectStoreNames.contains(CATEGORIES_STORE)) {
        const categoriesStore = db.createObjectStore(CATEGORIES_STORE, { keyPath: 'id', autoIncrement: true });
        categoriesStore.createIndex('name', 'name', { unique: true });
      }
      
      if (!db.objectStoreNames.contains(SETTINGS_STORE)) {
        db.createObjectStore(SETTINGS_STORE, { keyPath: 'key' });
      }
    };
    
    request.onsuccess = (event) => {
      db = event.target.result;
      resolve();
    };
    
    request.onerror = (event) => {
      console.error('Database error:', event.target.error);
      reject(event.target.error);
    };
  });
}

// Import data in chunks to prevent UI freezing
async function importCSVDataProgressively(csvString) {
  const lines = csvString.split('\n');
  const headers = lines[0].split(',');
  const totalLines = lines.length - 1;

  // Process in chunks of 50 items
  const CHUNK_SIZE = 50;
  const TOTAL_CHUNKS = Math.ceil(totalLines / CHUNK_SIZE);

  // Update progress modal
  updateImportProgress(0, TOTAL_CHUNKS);

  for (let chunk = 0; chunk < TOTAL_CHUNKS; chunk++) {
    const narratorsToAdd = [];
    // Calculate the start and end indices for this chunk
    const start = 1 + chunk * CHUNK_SIZE; // Start after header
    const end = Math.min(start + CHUNK_SIZE, lines.length);

    for (let i = start; i < end; i++) {
      try {
        const values = lines[i].split(',');
        const narrator = {};
        for (let j = 0; j < headers.length; j++) {
          narrator[headers[j]] = values[j] || '';
        }
        narratorsToAdd.push(narrator);
      } catch (e) {
        console.warn(`Error parsing line ${i}:`, e);
      }
    }

    // Save the current chunk
    await saveNarrators(narratorsToAdd);

    // Update progress
    updateImportProgress(chunk + 1, TOTAL_CHUNKS);

    // Allow UI to update by yielding to the event loop
    await new Promise(resolve => setTimeout(resolve, 0));
  }
}


// Update the import progress modal
function updateImportProgress(current, total) {
  const progressEl = document.getElementById('import-progress-bar');
  const percentEl = document.getElementById('import-progress-percent');
  
  if (progressEl && percentEl) {
    const percent = Math.round((current / total) * 100);
    progressEl.style.width = `${percent}%`;
    percentEl.textContent = `${percent}%`;
  }
}

// Show loading indicator
function showLoadingIndicator() {
  // Create if not exists
  if (!document.getElementById('app-loading-indicator')) {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'app-loading-indicator';
    loadingDiv.innerHTML = `
      
      
        Loading application...
        ایپلیکیشن لوڈ ہو رہی ہے...
      
    `;
    document.body.appendChild(loadingDiv);
  }
  
  document.getElementById('app-loading-indicator').style.display = 'flex';
}

// Hide loading indicator
function hideLoadingIndicator() {
  const indicator = document.getElementById('app-loading-indicator');
  if (indicator) {
    indicator.style.opacity = '0';
    setTimeout(() => {
      indicator.style.display = 'none';
    }, 500);
  }
}

function saveNarrators(narrators) {
  return new Promise((resolve, reject) => {
    if (!narrators || narrators.length === 0) {
      resolve();
      return;
    }

    const transaction = db.transaction([NARRATORS_STORE], 'readwrite');
    const store = transaction.objectStore(NARRATORS_STORE);

    let completed = 0;
    narrators.forEach(narrator => {
      // Ensure scholar_indx is a number if possible
      if (typeof narrator.scholar_indx === 'string') {
        const parsed = parseInt(narrator.scholar_indx, 10);
        if (!isNaN(parsed)) {
          narrator.scholar_indx = parsed;
        }
      }

      const request = store.put(narrator);
      request.onsuccess = () => {
        completed++;
        if (completed === narrators.length) {
          resolve();
        }
      };
      request.onerror = (event) => {
        console.error('Error saving narrator:', event.target.error);
        completed++;
        if (completed === narrators.length) {
          resolve(); // Resolves even if there are errors; change to reject if you want to fail on error
        }
      };
    });

    transaction.onerror = (event) => reject(event.target.error);
    // transaction.oncomplete is not strictly necessary here, as we resolve per record
  });
}


// Settings management
async function loadSettings() {
  currentLanguage = await getSettingValue('language') || 'en';
  currentTheme = await getSettingValue('theme') || 'light';
  
  document.body.className = `${currentTheme}-theme`;
  document.documentElement.lang = currentLanguage;
  document.documentElement.dir = currentLanguage === 'ur' ? 'rtl' : 'ltr';
}

async function updateSetting(key, value) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([SETTINGS_STORE], 'readwrite');
    const store = transaction.objectStore(SETTINGS_STORE);
    
    const request = store.put({ key, value });
    
    request.onsuccess = () => resolve();
    request.onerror = (event) => reject(event.target.error);
  });
}

async function getSettingValue(key) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([SETTINGS_STORE], 'readonly');
    const store = transaction.objectStore(SETTINGS_STORE);
    
    const request = store.get(key);
    
    request.onsuccess = (event) => {
      const result = event.target.result;
      resolve(result ? result.value : null);
    };
    
    request.onerror = (event) => reject(event.target.error);
  });
}

function updateLanguageDisplay() {
  // Hide all language specific elements
  document.querySelectorAll('.en, .ur').forEach(el => {
    el.style.display = 'none';
  });
  
  // Show only current language elements
  document.querySelectorAll(`.${currentLanguage}`).forEach(el => {
    el.style.display = 'inline-block';
  });
  
  // Update language toggle
  document.getElementById('language-toggle').checked = currentLanguage === 'en';
  document.getElementById('settings-language-toggle').checked = currentLanguage === 'en';
}

function updateThemeDisplay() {
  document.body.className = `${currentTheme}-theme`;
  document.getElementById('theme-toggle').checked = currentTheme === 'dark';
  document.getElementById('settings-theme-toggle').checked = currentTheme === 'dark';
}

// UI population with pagination
async function populateNarratorsList(filter = {}, page = 1) {
  const narratorsList = document.getElementById('narrator-list');
  narratorsList.innerHTML = 'Loading...';
  
  currentFilter = filter;
  currentPage = page;
  
  // Get total count first for pagination
  const allNarrators = await getNarrators(filter, false);
  totalNarrators = allNarrators.length;
  
  // Then get just the current page
  const narrators = await getNarrators(filter, true, page, ITEMS_PER_PAGE);
  
  narratorsList.innerHTML = '';
  
  if (narrators.length === 0) {
    narratorsList.innerHTML = `
      
        No narrators found
        کوئی راوی نہیں ملا
      
    `;
    return;
  }
  
  narrators.forEach(narrator => {
    const item = document.createElement('div');
    item.className = 'narrator-item slide-in';
    item.dataset.id = narrator.scholar_indx;
    item.innerHTML = `${narrator.name}`;
    
    item.addEventListener('click', () => {
      document.querySelectorAll('.narrator-item').forEach(el => {
        el.classList.remove('active');
      });
      item.classList.add('active');
      displayNarratorDetails(narrator);
    });
    
    narratorsList.appendChild(item);
  });
  
  // Add pagination controls
  addPaginationControls(narratorsList);
  
  updateLanguageDisplay();
}

// Add pagination controls
function addPaginationControls(container) {
  const totalPages = Math.ceil(totalNarrators / ITEMS_PER_PAGE);
  
  if (totalPages)  {
    if (currentPage > 1) {
      populateNarratorsList(currentFilter, currentPage - 1);
    }
  });
  
  // Next button
  const nextBtn = document.createElement('button');
  nextBtn.className = 'btn pagination-btn';
  nextBtn.innerHTML = '&raquo;';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.addEventListener('click', () => {
    if (currentPage Page ${currentPage} of ${totalPages}
    صفحہ ${currentPage} از ${totalPages}
  `;
  
  paginationDiv.appendChild(prevBtn);
  paginationDiv.appendChild(pageInfo);
  paginationDiv.appendChild(nextBtn);
  
  container.appendChild(paginationDiv);
}

// Optimize filters to load lazily
async function populateFilters() {
  // Use a sample of narrators instead of processing all
  // This improves performance significantly
  const sampleSize = 100;
  const narrators = await getSampleNarrators(sampleSize);
  
  const generations = new Set();
  const interests = new Set();
  const tags = new Set();
  const categories = await getAllCategories();
  
  narrators.forEach(narrator => {
    if (narrator.grade) generations.add(narrator.grade);
    
    if (narrator.area_of_interest) {
      narrator.area_of_interest.split(', ').forEach(interest => {
        interests.add(interest.trim());
      });
    }
    
    if (narrator.tags) {
      narrator.tags.split(', ').forEach(tag => {
        const match = tag.match(/\[(.*?)\]/);
        if (match) {
          tags.add(match[1]);
        }
      });
    }
  });
  
  const generationFilter = document.getElementById('generation-filter');
  const interestFilter = document.getElementById('interest-filter');
  const tagFilter = document.getElementById('tag-filter');
  const categoryFilter = document.getElementById('category-filter');
  
  generationFilter.innerHTML = 'All';
  interestFilter.innerHTML = 'All';
  tagFilter.innerHTML = 'All';
  categoryFilter.innerHTML = 'All';
  
  generations.forEach(gen => {
    generationFilter.innerHTML += `${gen}`;
  });
  
  interests.forEach(interest => {
    interestFilter.innerHTML += `${interest}`;
  });
  
  tags.forEach(tag => {
    tagFilter.innerHTML += `${tag}`;
  });
  
  categories.forEach(category => {
    categoryFilter.innerHTML += `${category.name}`;
  });
}

// Get a sample of narrators for filtering
async function getSampleNarrators(sampleSize) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([NARRATORS_STORE], 'readonly');
    const store = transaction.objectStore(NARRATORS_STORE);
    const request = store.openCursor();
    
    const narrators = [];
    let count = 0;
    
    request.onsuccess = (event) => {
      const cursor = event.target.result;
      
      if (cursor && count  reject(event.target.error);
  });
}

function displayNarratorDetails(narrator) {
  currentNarrator = narrator;
  
  document.querySelector('.narrator-placeholder').classList.add('hidden');
  document.querySelector('.narrator-content').classList.remove('hidden');
  
  document.getElementById('narrator-name').textContent = narrator.name;
  document.getElementById('narrator-grade').textContent = narrator.grade || 'N/A';
  document.getElementById('narrator-birth').textContent = narrator.birth_date_place || 'N/A';
  document.getElementById('narrator-death').textContent = narrator.death_date_place || 'N/A';
  document.getElementById('narrator-places').textContent = narrator.places_of_stay || 'N/A';
  
  document.getElementById('narrator-parents').textContent = narrator.parents || 'N/A';
  document.getElementById('narrator-spouse').textContent = narrator.spouse || 'N/A';
  document.getElementById('narrator-siblings').textContent = narrator.siblings || 'N/A';
  document.getElementById('narrator-children').textContent = narrator.children || 'N/A';
  document.getElementById('narrator-teachers').textContent = narrator.teachers || 'N/A';
  document.getElementById('narrator-students').textContent = narrator.students || 'N/A';
  
  checkBookmarkStatus();
  loadNarratorNotes();
  
  // Delay visualization to prevent UI hanging
  setTimeout(generateVisualizations, 100);
}

async function checkBookmarkStatus() {
  const bookmarkBtn = document.getElementById('bookmark-btn');
  const isBookmarked = await isNarratorBookmarked(currentNarrator.scholar_indx);
  
  bookmarkBtn.innerHTML = isBookmarked
    ? 'bookmark'
    : 'bookmark_border';
}

async function loadNarratorNotes() {
  const notesContainer = document.getElementById('notes-container');
  notesContainer.innerHTML = '';
  
  const notes = await getNarratorNotes(currentNarrator.scholar_indx);
  
  if (notes.length === 0) {
    notesContainer.innerHTML = `
      
        No notes added yet
        ابھی تک کوئی نوٹ نہیں شامل کیا گیا
      
    `;
    return;
  }
  
  notes.forEach(note => {
    const noteEl = document.createElement('div');
    noteEl.className = 'note-item fade-in';
    noteEl.innerHTML = `
      ${note.text}
      
        
          delete
        
      
    `;
    
    notesContainer.appendChild(noteEl);
  });
}

function generateVisualizations() {
  // This is a simplified visualization
  const treeViz = document.getElementById('tree-visualization');
  const graphViz = document.getElementById('graph-visualization');
  
  if (!treeViz || !graphViz) return;
  
  // Generate tree visualization
  treeViz.innerHTML = `
    
      
        
        ${currentNarrator.name.slice(0, 10)}...
        
        
        ${generateTreeNodes(parseRelationships(currentNarrator.teachers), -200, 100, 'Teachers')}
        
        
        ${generateTreeNodes(parseRelationships(currentNarrator.students), 200, 100, 'Students')}
        
        
        ${generateTreeNodes(parseRelationships(currentNarrator.children), 0, 150, 'Children')}
      
    
  `;
  
  // Generate graph visualization
  graphViz.innerHTML = `
    
      
        
        ${currentNarrator.name.slice(0, 10)}...
        
        
        ${generateGraphConnections()}
      
    
  `;
}

function parseRelationships(relationshipString) {
  if (!relationshipString) return [];
  
  return relationshipString.split(', ')
    .map(name => name.trim())
    .filter(name => name && name !== 'NA' && name !== 'others');
}

function generateTreeNodes(items, xOffset, yOffset, labelText) {
  if (items.length === 0) return '';
  
  const maxItems = 5;
  const displayItems = items.slice(0, maxItems);
  const angleStep = Math.PI / (displayItems.length + 1);
  
  let result = `
    ${labelText}
    
  `;
  
  displayItems.forEach((item, i) => {
    const angle = (i + 1) * angleStep;
    const x = xOffset + 80 * Math.cos(angle) - 80;
    const y = yOffset + 80 * Math.sin(angle);
    
    result += `
      
      ${item.slice(0, 8)}...
      
    `;
  });
  
  if (items.length > maxItems) {
    result += `
      +${items.length - maxItems} more
    `;
  }
  
  return result;
}

function generateGraphConnections() {
  const relationships = [
    ...parseRelationships(currentNarrator.teachers),
    ...parseRelationships(currentNarrator.students),
    ...parseRelationships(currentNarrator.children)
  ];
  
  if (relationships.length === 0) return '';
  
  const maxNodes = 8;
  const displayNodes = relationships.slice(0, maxNodes);
  const radius = 150;
  
  let result = '';
  
  displayNodes.forEach((item, i) => {
    const angle = (i * 2 * Math.PI) / displayNodes.length;
    const x = radius * Math.cos(angle);
    const y = radius * Math.sin(angle);
    
    const relationshipType = 
      currentNarrator.teachers && currentNarrator.teachers.includes(item) ? 'Teacher' :
      currentNarrator.students && currentNarrator.students.includes(item) ? 'Student' : 'Family';
    
    const color = 
      relationshipType === 'Teacher' ? '#e53935' :
      relationshipType === 'Student' ? '#43a047' : '#ffa000';
    
    result += `
      
      ${item.slice(0, 8)}...
      ${relationshipType}
      
    `;
  });
  
  if (relationships.length > maxNodes) {
    result += `
      +${relationships.length - maxNodes} more connections
    `;
  }
  
  return result;
}

// Data access functions with pagination
async function getNarrators(filter = {}, paginate = true, page = 1, itemsPerPage = ITEMS_PER_PAGE) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([NARRATORS_STORE], 'readonly');
    const store = transaction.objectStore(NARRATORS_STORE);
    const request = store.openCursor();
    
    const narrators = [];
    let skipCount = 0;
    let currentCount = 0;
    
    // Calculate items to skip based on page
    const skip = paginate ? (page - 1) * itemsPerPage : 0;
    // Max items to take
    const take = paginate ? itemsPerPage : Number.MAX_SAFE_INTEGER;
    
    request.onsuccess = (event) => {
      const cursor = event.target.result;
      
      if (cursor) {
        const narrator = cursor.value;
        let matches = true;
        
        // Apply filters
        if (filter.search && !narrator.name.toLowerCase().includes(filter.search.toLowerCase())) {
          matches = false;
        }
        
        if (filter.generation && narrator.grade !== filter.generation) {
          matches = false;
        }
        
        if (filter.interest && (!narrator.area_of_interest || !narrator.area_of_interest.includes(filter.interest))) {
          matches = false;
        }
        
        if (filter.tag && (!narrator.tags || !narrator.tags.includes(filter.tag))) {
          matches = false;
        }
        
        if (matches) {
          if (skipCount  reject(event.target.error);
  });
}

async function getAllNarrators() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([NARRATORS_STORE], 'readonly');
    const store = transaction.objectStore(NARRATORS_STORE);
    const request = store.getAll();
    
    request.onsuccess = (event) => resolve(event.target.result);
    request.onerror = (event) => reject(event.target.error);
  });
}

async function getNarratorById(id) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([NARRATORS_STORE], 'readonly');
    const store = transaction.objectStore(NARRATORS_STORE);
    const request = store.get(id);
    
    request.onsuccess = (event) => resolve(event.target.result);
    request.onerror = (event) => reject(event.target.error);
  });
}

async function getNarratorNotes(narratorId) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([NOTES_STORE], 'readonly');
    const store = transaction.objectStore(NOTES_STORE);
    const index = store.index('narrator_id');
    const request = index.getAll(narratorId);
    
    request.onsuccess = (event) => resolve(event.target.result);
    request.onerror = (event) => reject(event.target.error);
  });
}

async function addNote(narratorId, text) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([NOTES_STORE], 'readwrite');
    const store = transaction.objectStore(NOTES_STORE);
    
    const note = {
      narrator_id: narratorId,
      text,
      date: new Date().toISOString()
    };
    
    const request = store.add(note);
    
    request.onsuccess = (event) => resolve(event.target.result);
    request.onerror = (event) => reject(event.target.error);
  });
}

async function deleteNote(noteId) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([NOTES_STORE], 'readwrite');
    const store = transaction.objectStore(NOTES_STORE);
    const request = store.delete(noteId);
    
    request.onsuccess = () => resolve();
    request.onerror = (event) => reject(event.target.error);
  });
}

async function bookmarkNarrator(narratorId) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([BOOKMARKS_STORE], 'readwrite');
    const store = transaction.objectStore(BOOKMARKS_STORE);
    
    const bookmark = {
      narrator_id: narratorId,
      date: new Date().toISOString()
    };
    
    const request = store.put(bookmark);
    
    request.onsuccess = () => resolve();
    request.onerror = (event) => reject(event.target.error);
  });
}

async function unbookmarkNarrator(narratorId) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([BOOKMARKS_STORE], 'readwrite');
    const store = transaction.objectStore(BOOKMARKS_STORE);
    const request = store.delete(narratorId);
    
    request.onsuccess = () => resolve();
    request.onerror = (event) => reject(event.target.error);
  });
}

async function isNarratorBookmarked(narratorId) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([BOOKMARKS_STORE], 'readonly');
    const store = transaction.objectStore(BOOKMARKS_STORE);
    const request = store.get(narratorId);
    
    request.onsuccess = (event) => resolve(!!event.target.result);
    request.onerror = (event) => reject(event.target.error);
  });
}

async function getAllCategories() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([CATEGORIES_STORE], 'readonly');
    const store = transaction.objectStore(CATEGORIES_STORE);
    const request = store.getAll();
    
    request.onsuccess = (event) => resolve(event.target.result);
    request.onerror = (event) => reject(event.target.error);
  });
}

async function addCategory(name) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([CATEGORIES_STORE], 'readwrite');
    const store = transaction.objectStore(CATEGORIES_STORE);
    
    const category = { name };
    const request = store.add(category);
    
    request.onsuccess = (event) => resolve(event.target.result);
    request.onerror = (event) => reject(event.target.error);
  });
}

// Export/Import data
async function exportData() {
  try {
    const narrators = await getAllNarrators();
    
    // Get all notes
    const notes = await new Promise((resolve, reject) => {
      const transaction = db.transaction([NOTES_STORE], 'readonly');
      const store = transaction.objectStore(NOTES_STORE);
      const request = store.getAll();
      
      request.onsuccess = (event) => resolve(event.target.result);
      request.onerror = (event) => reject(event.target.error);
    });
    
    // Get all bookmarks
    const bookmarks = await new Promise((resolve, reject) => {
      const transaction = db.transaction([BOOKMARKS_STORE], 'readonly');
      const store = transaction.objectStore(BOOKMARKS_STORE);
      const request = store.getAll();
      
      request.onsuccess = (event) => resolve(event.target.result);
      request.onerror = (event) => reject(event.target.error);
    });
    
    const categories = await getAllCategories();
    
    const exportData = {
      narrators,
      notes,
      bookmarks,
      categories,
      version: DB_VERSION,
      exportDate: new Date().toISOString()
    };
    
    return exportData;
  } catch (error) {
    console.error('Export error:', error);
    throw error;
  }
}

async function importData(data) {
  if (!data.narrators || !Array.isArray(data.narrators)) {
    throw new Error('Invalid import data format');
  }
  
  try {
    // Clear existing data
    await clearObjectStore(NARRATORS_STORE);
    await clearObjectStore(NOTES_STORE);
    await clearObjectStore(BOOKMARKS_STORE);
    await clearObjectStore(CATEGORIES_STORE);
    
    // Import data progressively to prevent UI freezing
    
    // Import narrators in chunks
    const CHUNK_SIZE = 50;
    const narratorChunks = chunkArray(data.narrators, CHUNK_SIZE);
    
    for (let i = 0; i  setTimeout(resolve, 0));
    }
    
    // Import notes in chunks
    if (data.notes && Array.isArray(data.notes)) {
      const noteChunks = chunkArray(data.notes, CHUNK_SIZE);
      
      for (let i = 0; i  {
          const transaction = db.transaction([NOTES_STORE], 'readwrite');
          const store = transaction.objectStore(NOTES_STORE);
          
          let count = 0;
          noteChunks[i].forEach(note => {
            const request = store.add(note);
            request.onsuccess = () => {
              count++;
              if (count === noteChunks[i].length) {
                resolve();
              }
            };
            request.onerror = (event) => {
              console.error('Error importing note:', event.target.error);
              count++;
              if (count === noteChunks[i].length) {
                resolve();
              }
            };
          });
          
          transaction.oncomplete = () => resolve();
          transaction.onerror = (event) => reject(event.target.error);
        });
        
        // Allow UI to update
        await new Promise(resolve => setTimeout(resolve, 0));
      }
    }
    
    // Import bookmarks
    if (data.bookmarks && Array.isArray(data.bookmarks)) {
      await new Promise((resolve, reject) => {
        const transaction = db.transaction([BOOKMARKS_STORE], 'readwrite');
        const store = transaction.objectStore(BOOKMARKS_STORE);
        
        let count = 0;
        data.bookmarks.forEach(bookmark => {
          const request = store.add(bookmark);
          request.onsuccess = () => {
            count++;
            if (count === data.bookmarks.length) {
              resolve();
            }
          };
          request.onerror = (event) => {
            console.error('Error importing bookmark:', event.target.error);
            count++;
            if (count === data.bookmarks.length) {
              resolve();
            }
          };
        });
        
        transaction.oncomplete = () => resolve();
        transaction.onerror = (event) => reject(event.target.error);
      });
    }
    
    // Import categories
    if (data.categories && Array.isArray(data.categories)) {
      await new Promise((resolve, reject) => {
        const transaction = db.transaction([CATEGORIES_STORE], 'readwrite');
        const store = transaction.objectStore(CATEGORIES_STORE);
        
        let count = 0;
        data.categories.forEach(category => {
          const request = store.add(category);
          request.onsuccess = () => {
            count++;
            if (count === data.categories.length) {
              resolve();
            }
          };
          request.onerror = (event) => {
            console.error('Error importing category:', event.target.error);
            count++;
            if (count === data.categories.length) {
              resolve();
            }
          };
        });
        
        transaction.oncomplete = () => resolve();
        transaction.onerror = (event) => reject(event.target.error);
      });
    }
    
    return true;
  } catch (error) {
    console.error('Import error:', error);
    throw error;
  }
}

// Helper function to chunk arrays for progressive processing
function chunkArray(array, chunkSize) {
  const chunks = [];
  for (let i = 0; i  {
    const transaction = db.transaction([storeName], 'readwrite');
    const store = transaction.objectStore(storeName);
    const request = store.clear();
    
    request.onsuccess = () => resolve();
    request.onerror = (event) => reject(event.target.error);
  });
}

// Event listeners
function setupEventListeners() {
  // Language toggle
  document.getElementById('language-toggle').addEventListener('change', (e) => {
    currentLanguage = e.target.checked ? 'en' : 'ur';
    document.getElementById('settings-language-toggle').checked = e.target.checked;
    updateLanguageSetting();
  });
  
  document.getElementById('settings-language-toggle').addEventListener('change', (e) => {
    currentLanguage = e.target.checked ? 'en' : 'ur';
    document.getElementById('language-toggle').checked = e.target.checked;
    updateLanguageSetting();
  });
  
  // Theme toggle
  document.getElementById('theme-toggle').addEventListener('change', (e) => {
    currentTheme = e.target.checked ? 'dark' : 'light';
    document.getElementById('settings-theme-toggle').checked = e.target.checked;
    updateThemeSetting();
  });
  
  document.getElementById('settings-theme-toggle').addEventListener('change', (e) => {
    currentTheme = e.target.checked ? 'dark' : 'light';
    document.getElementById('theme-toggle').checked = e.target.checked;
    updateThemeSetting();
  });
  
  // Search - with debounce to prevent UI freeze
  let searchTimeout;
  document.getElementById('search-input').addEventListener('keyup', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if (e.key === 'Enter') {
        const searchTerm = e.target.value.trim();
        populateNarratorsList({ search: searchTerm }, 1);
      }
    }, 300);
  });
  
  document.getElementById('search-btn').addEventListener('click', () => {
    const searchTerm = document.getElementById('search-input').value.trim();
    populateNarratorsList({ search: searchTerm }, 1);
  });
  
  // Filters
  document.getElementById('generation-filter').addEventListener('change', updateFilters);
  document.getElementById('interest-filter').addEventListener('change', updateFilters);
  document.getElementById('tag-filter').addEventListener('change', updateFilters);
  document.getElementById('category-filter').addEventListener('change', updateFilters);
  
  // Tabs
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      const tabId = tab.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`${tabId}-tab`).classList.remove('hidden');
      
      if (tabId === 'visualization' && currentNarrator) {
        setTimeout(generateVisualizations, 100);
      }
    });
  });
  
  // Visualization controls
  document.getElementById('tree-view-btn').addEventListener('click', () => {
    document.getElementById('tree-visualization').classList.remove('hidden');
    document.getElementById('graph-visualization').classList.add('hidden');
  });
  
  document.getElementById('graph-view-btn').addEventListener('click', () => {
    document.getElementById('tree-visualization').classList.add('hidden');
    document.getElementById('graph-visualization').classList.remove('hidden');
  });
  
  // Notes
  document.getElementById('save-note-btn').addEventListener('click', async () => {
    const noteText = document.getElementById('note-input').value.trim();
    if (noteText && currentNarrator) {
      await addNote(currentNarrator.scholar_indx, noteText);
      document.getElementById('note-input').value = '';
      await loadNarratorNotes();
    }
  });
  
  // Note delete buttons are added dynamically, so we use event delegation
  document.getElementById('notes-container').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('[data-action="delete-note"]');
    if (deleteBtn) {
      const noteId = parseInt(deleteBtn.dataset.noteId);
      await deleteNote(noteId);
      await loadNarratorNotes();
    }
  });
  
  // Bookmark toggle
  document.getElementById('bookmark-btn').addEventListener('click', async () => {
    if (!currentNarrator) return;
    
    const isBookmarked = await isNarratorBookmarked(currentNarrator.scholar_indx);
    
    if (isBookmarked) {
      await unbookmarkNarrator(currentNarrator.scholar_indx);
    } else {
      await bookmarkNarrator(currentNarrator.scholar_indx);
    }
    
    checkBookmarkStatus();
  });
  
  // Category button
  document.getElementById('category-btn').addEventListener('click', () => {
    if (!currentNarrator) return;
    populateCategoriesModal();
    showModal('category-modal');
  });
  
  // Import/Export
  document.getElementById('import-btn').addEventListener('click', () => {
    showModal('import-modal');
  });
  
  document.getElementById('export-btn').addEventListener('click', () => {
    showModal('export-modal');
  });
  
  document.getElementById('import-file-btn').addEventListener('click', async () => {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    
    if (!file) {
      alert('Please select a file to import');
      return;
    }
    
    showLoadingIndicator();
    
    const reader = new FileReader();
    
    reader.onload = async (e) => {
      try {
        if (file.name.endsWith('.csv')) {
          await importCSVDataProgressively(e.target.result);
        } else if (file.name.endsWith('.json')) {
          const data = JSON.parse(e.target.result);
          await importData(data);
        } else {
          alert('Unsupported file format. Please use CSV or JSON.');
          hideLoadingIndicator();
          return;
        }
        
        hideModal('import-modal');
        await populateNarratorsList();
        await populateFilters();
        
        hideLoadingIndicator();
        alert('Data imported successfully!');
      } catch (error) {
        console.error('Import error:', error);
        hideLoadingIndicator();
        alert(`Import failed: ${error.message}`);
      }
    };
    
    reader.readAsText(file);
  });
  
  document.getElementById('export-file-btn').addEventListener('click', async () => {
    try {
      showLoadingIndicator();
      const data = await exportData();
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `isnad_narrators_export_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      hideModal('export-modal');
      hideLoadingIndicator();
    } catch (error) {
      console.error('Export error:', error);
      hideLoadingIndicator();
      alert(`Export failed: ${error.message}`);
    }
  });
  
  // Settings
  document.getElementById('settings-btn').addEventListener('click', () => {
    showModal('settings-modal');
  });
  
  document.getElementById('reset-data-btn').addEventListener('click', async () => {
    if (confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
      showLoadingIndicator();
      
      try {
        await clearObjectStore(NARRATORS_STORE);
        await clearObjectStore(NOTES_STORE);
        await clearObjectStore(BOOKMARKS_STORE);
        await clearObjectStore(CATEGORIES_STORE);
        
        const response = await fetch('all_rawis.csv');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvData = await response.text();
        await importCSVDataProgressively(csvData);
        
        await populateNarratorsList();
        await populateFilters();
        
        hideModal('settings-modal');
        hideLoadingIndicator();
        alert('Data has been reset successfully');
      } catch (error) {
        console.error('Reset error:', error);
        hideLoadingIndicator();
        alert(`Reset failed: ${error.message}`);
      }
    }
  });
  
  // Modal close buttons
  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
      hideModal(btn.closest('.modal').id);
    });
  });
  
  // Onboarding and disclaimer buttons
  document.getElementById('start-app-btn').addEventListener('click', () => {
    hideModal('onboarding-modal');
    showModal('disclaimer-modal');
  });
  
  document.getElementById('accept-disclaimer-btn').addEventListener('click', async () => {
    await updateSetting('hasCompletedOnboarding', true);
    hideModal('disclaimer-modal');
  });
  
  // Category management
  document.getElementById('add-category-btn').addEventListener('click', async () => {
    const categoryName = document.getElementById('new-category-input').value.trim();
    
    if (categoryName) {
      try {
        await addCategory(categoryName);
        document.getElementById('new-category-input').value = '';
        await populateCategoriesModal();
        await populateFilters();
      } catch (error) {
        console.error('Add category error:', error);
        alert(`Failed to add category: ${error.message}`);
      }
    }
  });
}

async function updateFilters() {
  const generationFilter = document.getElementById('generation-filter').value;
  const interestFilter = document.getElementById('interest-filter').value;
  const tagFilter = document.getElementById('tag-filter').value;
  const categoryFilter = document.getElementById('category-filter').value;
  
  const filter = {};
  if (generationFilter) filter.generation = generationFilter;
  if (interestFilter) filter.interest = interestFilter;
  if (tagFilter) filter.tag = tagFilter;
  if (categoryFilter) filter.category = categoryFilter;
  
  // Always start from page 1 when filters change
  await populateNarratorsList(filter, 1);
}

async function updateLanguageSetting() {
  document.documentElement.lang = currentLanguage;
  document.documentElement.dir = currentLanguage === 'ur' ? 'rtl' : 'ltr';
  updateLanguageDisplay();
  await updateSetting('language', currentLanguage);
}

async function updateThemeSetting() {
  document.body.className = `${currentTheme}-theme`;
  await updateSetting('theme', currentTheme);
  
  if (currentNarrator) {
    setTimeout(generateVisualizations, 100);
  }
}

async function populateCategoriesModal() {
  const categoriesList = document.getElementById('categories-list');
  categoriesList.innerHTML = '';
  
  const categories = await getAllCategories();
  
  if (categories.length === 0) {
    categoriesList.innerHTML = `
      
        No categories added yet
        ابھی تک کوئی زمرہ شامل نہیں کیا گیا
      
    `;
    return;
  }
  
  categories.forEach(category => {
    const item = document.createElement('div');
    item.className = 'category-item';
    item.innerHTML = `
      
        
        ${category.name}
      
    `;
    
    categoriesList.appendChild(item);
  });
}

// Modal helpers
function showModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('active');
  }
}

function hideModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('active');
  }
}

// File API check
if (typeof FileReader === 'undefined') {
  alert('Sorry, your browser does not support the File API needed for importing data.');
}  </script>
</body>
</html>
