<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isnad Narrators Explorer</title>
    <meta name="author" content="Yasin Ullah">
    <meta name="description" content="Explore Isnad narrators, relationships, and details.">
    <!-- Consider adding a minimal icon library like Font Awesome or Material Icons via CDN if needed -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> -->
    <!-- Google Fonts for English and Urdu -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --font-en: 'Poppins', sans-serif;
            --font-ur: 'Noto Nastaliq Urdu', serif;

            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-light: #f8f9fa;
            --text-light: #212529;
            --card-bg-light: #ffffff;
            --border-light: #dee2e6;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);

            --background-dark: #1a1a1a; /* Darker background */
            --text-dark: #e0e0e0; /* Lighter text */
            --card-bg-dark: #2c2c2c; /* Darker card background */
            --border-dark: #444;
            --shadow-dark: 0 4px 15px rgba(0, 0, 0, 0.3);

            --accent-color: #17a2b8;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;

            --border-radius: 8px;
            --transition-speed: 0.3s;

            /* Default to light theme */
            --bg-color: var(--background-light);
            --text-color: var(--text-light);
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-light);
            --shadow: var(--shadow-light);
        }

        .dark-theme {
            --bg-color: var(--background-dark);
            --text-color: var(--text-dark);
            --card-bg: var(--card-bg-dark);
            --border-color: var(--border-dark);
            --shadow: var(--shadow-dark);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-en);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* --- RTL/LTR Specific Styles --- */
        html[dir="rtl"] body {
            font-family: var(--font-ur), var(--font-en); /* Fallback to English font */
        }

        html[dir="rtl"] .sidebar { border-left: 1px solid var(--border-color); border-right: none; }
        html[dir="ltr"] .sidebar { border-right: 1px solid var(--border-color); border-left: none; }
        html[dir="rtl"] .main-content { margin-right: 300px; margin-left: 0; }
        html[dir="ltr"] .main-content { margin-left: 300px; margin-right: 0; }
        html[dir="rtl"] .modal-content { text-align: right; }
        html[dir="ltr"] .modal-content { text-align: left; }
        html[dir="rtl"] input, html[dir="rtl"] textarea, html[dir="rtl"] select { text-align: right; }
        html[dir="ltr"] input, html[dir="ltr"] textarea, html[dir="ltr"] select { text-align: left; }
        html[dir="rtl"] .narrator-card .actions { justify-content: flex-start; }
        html[dir="ltr"] .narrator-card .actions { justify-content: flex-end; }
        html[dir="rtl"] .tree ul { padding-right: 20px; padding-left: 0; }
        html[dir="ltr"] .tree ul { padding-left: 20px; padding-right: 0; }
        html[dir="rtl"] .tree li::before { right: -10px; left: auto; }
        html[dir="ltr"] .tree li::before { left: -10px; right: auto; }
        html[dir="rtl"] .tree li::after { right: -10px; left: auto; }
        html[dir="ltr"] .tree li::after { left: -10px; right: auto; }


        /* --- Layout --- */
        .app-container {
            display: flex;
            flex: 1; /* Fill remaining vertical space */
        }

        .sidebar {
            width: 300px;
            background-color: var(--card-bg);
            padding: 20px;
            position: fixed;
            top: 0;
            bottom: 0;
            overflow-y: auto;
            transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease;
            box-shadow: var(--shadow);
            z-index: 100;
        }
        html[dir="rtl"] .sidebar { right: 0; }
        html[dir="ltr"] .sidebar { left: 0; }


        .main-content {
            flex: 1;
            padding: 20px;
            transition: margin var(--transition-speed) ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 1.5rem;
            margin: 0;
            color: var(--primary-color);
        }

        .header-controls button, .header-controls label {
            margin-inline-start: 10px; /* Handles LTR/RTL */
        }

        /* --- Components --- */
        .button {
            padding: 8px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color var(--transition-speed) ease, transform 0.1s ease;
            background-color: var(--primary-color);
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .button:hover {
            opacity: 0.9;
        }
        .button:active {
            transform: scale(0.98);
        }
        .button-secondary { background-color: var(--secondary-color); }
        .button-success { background-color: var(--success-color); }
        .button-danger { background-color: var(--danger-color); }
        .button-warning { background-color: var(--warning-color); color: #333; }
        .button-icon { padding: 8px; }

        input[type="text"], input[type="search"], textarea, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
            transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .narrator-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .narrator-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease-in-out, box-shadow var(--transition-speed) ease, background-color var(--transition-speed) ease;
            cursor: pointer;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        .narrator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        }
        .dark-theme .narrator-card:hover {
             box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .narrator-card h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--primary-color);
            flex-grow: 1; /* Push actions down */
        }
        .narrator-card p {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        .narrator-card .tags span {
            background-color: var(--accent-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-inline-end: 5px; /* LTR/RTL */
            margin-bottom: 5px;
            display: inline-block;
        }
         .narrator-card .actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
         }
         .narrator-card .actions button {
            padding: 5px;
            font-size: 0.8rem;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--secondary-color);
         }
         .narrator-card .actions button.bookmarked {
            color: var(--warning-color);
            border-color: var(--warning-color);
         }
         .narrator-card .actions button:hover {
            background-color: rgba(0,0,0,0.05);
         }
         .dark-theme .narrator-card .actions button:hover {
            background-color: rgba(255,255,255,0.1);
         }


        .narrator-detail-view {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-top: 20px;
            animation: fadeIn 0.5s ease;
            border: 1px solid var(--border-color);
        }
        .narrator-detail-view h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .detail-section {
            margin-bottom: 25px;
        }
        .detail-section h4 {
            margin-bottom: 10px;
            color: var(--accent-color);
            font-size: 1.1rem;
        }
        .detail-section p, .detail-section ul {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .detail-section strong {
            min-width: 120px;
            display: inline-block;
        }
        html[dir="rtl"] .detail-section strong {
             margin-left: 10px;
        }
        html[dir="ltr"] .detail-section strong {
             margin-right: 10px;
        }
        .detail-section ul {
            list-style: none;
            padding: 0;
        }
        .detail-section li {
            margin-bottom: 5px;
        }
        .detail-section .link {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }
        .detail-section .link:hover {
            text-decoration: underline;
        }
        .detail-section .tags span {
             background-color: var(--secondary-color);
             color: white;
             padding: 3px 8px;
             border-radius: 15px;
             font-size: 0.8rem;
             margin-inline-end: 5px;
             margin-bottom: 5px;
             display: inline-block;
        }

        /* --- Tree Visualization --- */
        .tree-container {
            margin-top: 20px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow-x: auto; /* Allow horizontal scrolling for large trees */
        }
        .tree ul {
            padding-top: 10px;
            position: relative;
            transition: all 0.5s;
            list-style: none;
        }
        .tree li {
            white-space: nowrap;
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            position: relative;
            transition: all 0.3s;
        }
        .tree li span {
            cursor: pointer;
            display: block;
            padding: 5px;
        }
        .tree li span:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .tree li.current-node {
            border-color: var(--primary-color);
            background-color: rgba(0, 123, 255, 0.05);
            font-weight: bold;
        }

        /* Basic connectors - can be enhanced */
        .tree ul ul::before {
            content: '';
            position: absolute;
            top: 0;
            width: 1px;
            height: 100%;
            background-color: var(--secondary-color);
            opacity: 0.5;
        }
        html[dir="rtl"] .tree ul ul::before { right: -10px; }
        html[dir="ltr"] .tree ul ul::before { left: -10px; }

        .tree li::before, .tree li::after {
            content: '';
            position: absolute;
            top: 50%;
            height: 1px;
            width: 10px;
            background-color: var(--secondary-color);
            opacity: 0.5;
            transform: translateY(-50%);
        }
        html[dir="rtl"] .tree li::before { right: 100%; }
        html[dir="ltr"] .tree li::before { left: 100%; }

        html[dir="rtl"] .tree li::after { right: -10px; }
        html[dir="ltr"] .tree li::after { left: -10px; }

        .tree li:last-child::before { display: none; } /* Hide connector for last item */
        .tree > ul > li::after { display: none; } /* Hide connector for root */

        /* --- Infographics (Simple Example) --- */
        .infographics {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .info-card {
            flex: 1;
            min-width: 150px;
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .info-card .value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .info-card .label {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        /* --- Modals --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 600px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-dark); /* Use dark shadow for contrast */
            position: relative;
            animation: slideIn 0.4s ease-out;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--secondary-color);
            cursor: pointer;
            line-height: 1;
        }
        html[dir="rtl"] .modal-close { left: 15px; }
        html[dir="ltr"] .modal-close { right: 15px; }

        .modal-close:hover, .modal-close:focus {
            color: var(--text-color);
            text-decoration: none;
        }
        .modal h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        /* --- Loading Indicator --- */
        .loading-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        .loading-overlay.show {
            display: flex;
        }
        .loader {
            border: 8px solid var(--border-light); /* Light grey */
            border-top: 8px solid var(--primary-color); /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        /* --- Animations --- */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
             from { transform: translateY(-30px); opacity: 0; }
             to { transform: translateY(0); opacity: 1; }
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            html[dir="rtl"] .main-content { margin-right: 0; }
            html[dir="ltr"] .main-content { margin-left: 0; }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-right: none;
                border-left: none;
                border-bottom: 1px solid var(--border-color);
                box-shadow: none;
                z-index: 1; /* Lower z-index */
            }
            .app-container {
                flex-direction: column;
            }
            .header h1 { font-size: 1.3rem; }
            .header-controls { display: flex; flex-wrap: wrap; justify-content: flex-end; }
            .header-controls button, .header-controls label { margin-top: 5px; }
            .narrator-list { grid-template-columns: 1fr; } /* Single column on small screens */
            .modal-content { width: 95%; padding: 20px; }
            .infographics { justify-content: center; }
        }

        /* --- Utility Classes --- */
        .hidden { display: none !important; }
        .text-danger { color: var(--danger-color); }
        .text-success { color: var(--success-color); }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .bold { font-weight: bold; }

        /* --- Category Pills --- */
        .category-pills {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .category-pill {
            background-color: var(--secondary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .category-pill:hover {
            background-color: var(--primary-color);
        }
        .category-pill.active {
            background-color: var(--accent-color);
            font-weight: bold;
        }
        .category-pill .delete-cat {
            font-size: 0.7rem;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            margin-inline-start: 4px;
        }
        .category-pill .delete-cat:hover {
            background: var(--danger-color);
        }

    </style>
</head>
<body>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="header">
                <h1 data-i18n="appTitle">Isnad Explorer</h1>
                <div class="header-controls">
                     <!-- Theme Toggle -->
                    <button id="theme-toggle" class="button button-icon button-secondary" aria-label="Toggle Theme">
                        ☀️ <!-- Placeholder, JS will set correct icon -->
                    </button>
                    <!-- Language Toggle -->
                    <button id="language-toggle" class="button button-secondary" data-i18n="langToggle">English</button>
                </div>
            </div>

            <!-- Search -->
            <div class="form-group">
                <label for="search-input" data-i18n="searchLabel">Search Narrators</label>
                <input type="search" id="search-input" data-i18n-placeholder="searchPlaceholder" placeholder="Name, tag, place...">
            </div>

            <!-- Filters -->
            <div class="form-group">
                <label for="filter-grade" data-i18n="filterGrade">Filter by Grade</label>
                <select id="filter-grade">
                    <option value="" data-i18n="allGrades">All Grades</option>
                    <!-- Options populated by JS -->
                </select>
            </div>

             <!-- Categories -->
            <div class="form-group">
                <label data-i18n="categoriesLabel">Categories</label>
                <div id="category-pills-container" class="category-pills">
                    <button class="category-pill" data-category-id="all" data-i18n="allCategory">All</button>
                    <button class="category-pill" data-category-id="bookmarked" data-i18n="bookmarkedCategory">Bookmarked</button>
                    <!-- User categories populated by JS -->
                </div>
                <button id="add-category-btn" class="button button-secondary" data-i18n="addCategoryBtn">Add Category</button>
            </div>


            <!-- Data Management -->
            <div class="form-group mt-2">
                 <label data-i18n="dataManagementLabel">Data Management</label>
                 <button id="export-data-btn" class="button button-success" data-i18n="exportDataBtn">Export Data (JSON)</button>
                 <label for="import-data-input" class="button button-warning mt-1" data-i18n="importDataBtn">Import Data (JSON)</label>
                 <input type="file" id="import-data-input" accept=".json" class="hidden">
            </div>

             <!-- Disclaimer -->
             <div class="form-group mt-2">
                 <button id="show-disclaimer-btn" class="button button-secondary" data-i18n="showDisclaimerBtn">Show Disclaimer</button>
             </div>

        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content-area">
            <!-- Narrator List View -->
			<div id="narrator-list-view">
					<h2 data-i18n="narratorsHeading">Narrators</h2>
					<!-- Moved no-results-message outside the list container -->
					<p id="no-results-message" class="hidden" data-i18n="noResults">No narrators found matching your criteria.</p>
					<div id="narrator-list" class="narrator-list">
						<!-- Narrator cards will be injected here -->
						<!-- The <p id="no-results-message"> was previously inside here, causing it to be deleted when the list was cleared -->
					</div>
					<div id="pagination-controls" class="pagination-controls" style="text-align: center; margin-top: 20px; padding-bottom: 20px;">
                    <!-- Buttons will be injected here by JS -->
                </div>
				</div>

            <!-- Narrator Detail View (Initially Hidden) -->
            <div id="narrator-detail-view" class="narrator-detail-view hidden">
                <!-- Details will be injected here -->
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="onboarding-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('onboarding-modal')">&times;</span>
            <h2 data-i18n="welcomeTitle">Welcome to Isnad Narrators Explorer!</h2>
            <p data-i18n="onboardingMsg1">This application helps you explore information about Hadith narrators and their relationships.</p>
            <p data-i18n="onboardingMsg2"><strong>Disclaimer:</strong> The data provided is based on available sources and may contain inaccuracies or require further verification. It is intended for informational purposes only. Use critical judgment when studying Isnad.</p>
            <p data-i18n="onboardingMsg3">Your notes, bookmarks, and categories are stored locally in your browser using IndexedDB. No data is sent to any server.</p>
            <p data-i18n="onboardingMsg4">You can backup and restore all your data using the export/import buttons in the sidebar.</p>
            <p><small>Author: Yasin Ullah (Pakistani)</small></p>
            <button class="button mt-2" onclick="closeModal('onboarding-modal'); markOnboardingComplete();" data-i18n="getStartedBtn">Get Started</button>
        </div>
    </div>

    <div id="disclaimer-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('disclaimer-modal')">&times;</span>
            <h2 data-i18n="disclaimerTitle">Disclaimer</h2>
            <p data-i18n="disclaimerMsg1">The data presented in the Isnad Narrators Explorer application is compiled from various sources for informational and research purposes. While efforts have been made to ensure accuracy, the information may contain errors, omissions, or reflect specific scholarly interpretations.</p>
            <p data-i18n="disclaimerMsg2">Users are strongly advised to consult original source materials and verify information independently, especially when conducting academic research or making religious determinations.</p>
            <p data-i18n="disclaimerMsg3">The application stores all user-generated data (notes, bookmarks, categories) locally within the user's browser via IndexedDB. No personal data is collected or transmitted to external servers. The user is solely responsible for backing up their local data using the provided export feature.</p>
             <p><small>Author: Yasin Ullah (Pakistani)</small></p>
            <button class="button mt-2" onclick="closeModal('disclaimer-modal')" data-i18n="closeBtn">Close</button>
        </div>
    </div>

    <div id="note-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('note-modal')">&times;</span>
            <h2 data-i18n="noteModalTitle">Add/Edit Note</h2>
            <input type="hidden" id="note-narrator-id">
            <div class="form-group">
                <label for="note-text" data-i18n="noteLabel">Note:</label>
                <textarea id="note-text" rows="5" data-i18n-placeholder="notePlaceholder" placeholder="Enter your note here..."></textarea>
            </div>
            <button id="save-note-btn" class="button button-success" data-i18n="saveBtn">Save Note</button>
            <button id="delete-note-btn" class="button button-danger hidden" data-i18n="deleteBtn">Delete Note</button>
        </div>
    </div>

     <div id="category-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('category-modal')">&times;</span>
            <h2 data-i18n="categoryModalTitle">Add New Category</h2>
            <div class="form-group">
                <label for="category-name" data-i18n="categoryNameLabel">Category Name:</label>
                <input type="text" id="category-name" data-i18n-placeholder="categoryNamePlaceholder" placeholder="Enter category name...">
            </div>
            <button id="save-category-btn" class="button button-success" data-i18n="saveBtn">Save Category</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loader"></div>
    </div>

    <!-- Embedded CSV Data -->
<script>
    // --- Constants and Globals ---
    const DB_NAME = 'IsnadNarratorsDB';
    const DB_VERSION = 1;
    const STORE_NARRATORS = 'narrators';
    const STORE_NOTES = 'notes';
    const STORE_BOOKMARKS = 'bookmarks';
    const STORE_CATEGORIES = 'categories';
    const ONBOARDING_KEY = 'isnadExplorerOnboardingComplete';
    const SETTINGS_KEY = 'isnadExplorerSettings';
    const CSV_FILE_PATH = 'all_rawis.csv'; // Path to your external CSV file
    const ITEMS_PER_PAGE = 24; // Number of narrators per page

    let db;
    let currentNarrators = []; // Holds the narrators for the CURRENT PAGE
    let allNarratorsData = []; // Holds ALL narrators from DB
    let filteredNarrators = []; // Holds the complete list after filtering
    let allNotes = {}; // { narratorId: "note text" }
    let allBookmarks = new Set(); // Set of bookmarked narrator IDs
    let allCategories = []; // [{ id: Date.now(), name: "Category Name" }]
    let currentFilters = { search: '', grade: '', categoryId: 'all' };
    let currentSettings = { theme: 'light', language: 'en' };
    let currentPage = 1;

    // --- Localization (i18n) ---
    const translations = {
        en: {
            appTitle: "Isnad Explorer",
            langToggle: "اردو",
            searchLabel: "Search Narrators",
            searchPlaceholder: "Name, tag, place...",
            filterGrade: "Filter by Grade",
            allGrades: "All Grades",
            categoriesLabel: "Categories",
            allCategory: "All",
            bookmarkedCategory: "Bookmarked",
            addCategoryBtn: "Add Category",
            dataManagementLabel: "Data Management",
            exportDataBtn: "Export Data (JSON)",
            importDataBtn: "Import Data (JSON)",
            showDisclaimerBtn: "Show Disclaimer",
            narratorsHeading: "Narrators",
            noResults: "No narrators found matching your criteria.",
            viewDetails: "View Details",
            addNote: "Add Note",
            editNote: "Edit Note",
            bookmark: "Bookmark",
            unbookmark: "Unbookmark",
            categorize: "Categorize",
            welcomeTitle: "Welcome to Isnad Narrators Explorer!",
            onboardingMsg1: "This application helps you explore information about Hadith narrators and their relationships.",
            onboardingMsg2: "<strong>Disclaimer:</strong> The data provided is based on available sources and may contain inaccuracies or require further verification. It is intended for informational purposes only. Use critical judgment when studying Isnad.",
            onboardingMsg3: "Your notes, bookmarks, and categories are stored locally in your browser using IndexedDB. No data is sent to any server.",
            onboardingMsg4: "You can backup and restore all your data using the export/import buttons in the sidebar.",
            getStartedBtn: "Get Started",
            disclaimerTitle: "Disclaimer",
            disclaimerMsg1: "The data presented in the Isnad Narrators Explorer application is compiled from various sources for informational and research purposes. While efforts have been made to ensure accuracy, the information may contain errors, omissions, or reflect specific scholarly interpretations.",
            disclaimerMsg2: "Users are strongly advised to consult original source materials and verify information independently, especially when conducting academic research or making religious determinations.",
            disclaimerMsg3: "The application stores all user-generated data (notes, bookmarks, categories) locally within the user's browser via IndexedDB. No personal data is collected or transmitted to external servers. The user is solely responsible for backing up their local data using the provided export feature.",
            closeBtn: "Close",
            noteModalTitle: "Add/Edit Note",
            noteLabel: "Note:",
            notePlaceholder: "Enter your note here...",
            saveBtn: "Save",
            deleteBtn: "Delete",
            categoryModalTitle: "Add New Category",
            categoryNameLabel: "Category Name:",
            categoryNamePlaceholder: "Enter category name...",
            backToList: "← Back to List",
            details: "Details",
            relationships: "Relationships",
            teachers: "Teachers",
            students: "Students",
            family: "Family",
            parents: "Parents",
            spouse: "Spouse(s)",
            siblings: "Siblings",
            children: "Children",
            lifeEvents: "Life & Places",
            birth: "Birth",
            death: "Death",
            placesOfStay: "Places of Stay",
            areaOfInterest: "Area of Interest",
            tags: "Tags",
            books: "Books",
            userNotes: "Your Notes",
            noNote: "No note added yet.",
            editNoteBtn: "Edit Note",
            addNoteBtn: "Add Note",
            infographics: "Infographics",
            lifespan: "Lifespan (approx)",
            years: "years",
            numTeachers: "Teachers",
            numStudents: "Students",
            loading: "Loading...",
            error: "Error",
            success: "Success",
            importSuccess: "Data imported successfully!",
            importError: "Error importing data. Ensure the file is valid JSON.",
            exportError: "Error exporting data.",
            dbError: "Database error occurred.",
            parseError: "Error parsing or fetching initial data.", // Updated message
            confirmImport: "This will replace all current data. Are you sure?",
            confirmCatDelete: "Delete category '{catName}'? Narrators in this category will be uncategorized.",
            selectCategories: "Select Categories",
            noCategories: "No categories created yet.",
            category: "Category",
            unassigned: "Unassigned",
            assignCategory: "Assign Category",
            removeCategory: "Remove Category",
            deleteCategory: "Delete Category",
            prevPage: "‹ Prev",
            nextPage: "Next ›",
            pageInfo: "Page {currentPage} of {totalPages}",
        },
        ur: {
            appTitle: "اسناد راوی ایکسپلورر",
            langToggle: "English",
            searchLabel: "راوی تلاش کریں",
            searchPlaceholder: "نام، ٹیگ، جگہ...",
            filterGrade: "درجہ کے لحاظ سے فلٹر کریں",
            allGrades: "تمام درجات",
            categoriesLabel: "زمرے",
            allCategory: "تمام",
            bookmarkedCategory: "بک مارک شدہ",
            addCategoryBtn: "نیا زمرہ شامل کریں",
            dataManagementLabel: "ڈیٹا مینجمنٹ",
            exportDataBtn: "ڈیٹا ایکسپورٹ کریں (JSON)",
            importDataBtn: "ڈیٹا امپورٹ کریں (JSON)",
            showDisclaimerBtn: "ڈس کلیمر دکھائیں",
            narratorsHeading: "راوی",
            noResults: "آپ کے معیار سے مماثل کوئی راوی نہیں ملا۔",
            viewDetails: "تفصیلات دیکھیں",
            addNote: "نوٹ شامل کریں",
            editNote: "نوٹ میں ترمیم کریں",
            bookmark: "بک مارک",
            unbookmark: "بک مارک ہٹائیں",
            categorize: "زمرہ بندی کریں",
            welcomeTitle: "اسناد راوی ایکسپلورر میں خوش آمدید!",
            onboardingMsg1: "یہ ایپلیکیشن آپ کو حدیث کے راویوں اور ان کے تعلقات کے بارے میں معلومات دریافت کرنے میں مدد کرتی ہے۔",
            onboardingMsg2: "<strong>ڈس کلیمر:</strong> فراہم کردہ ڈیٹا دستیاب ذرائع پر مبنی ہے اور اس میں غلطیاں ہوسکتی ہیں یا مزید تصدیق کی ضرورت پڑسکتی ہے۔ یہ صرف معلوماتی مقاصد کے لیے ہے۔ اسناد کا مطالعہ کرتے وقت تنقیدی شعور استعمال کریں۔",
            onboardingMsg3: "آپ کے نوٹس، بک مارکس، اور زمرے آپ کے براؤزر میں IndexedDB کا استعمال کرتے ہوئے مقامی طور پر محفوظ کیے جاتے ہیں۔ کوئی ڈیٹا کسی سرور پر نہیں بھیجا جاتا۔",
            onboardingMsg4: "آپ سائڈبار میں ایکسپورٹ/امپورٹ بٹنوں کا استعمال کرکے اپنے تمام ڈیٹا کا بیک اپ اور بحال کرسکتے ہیں۔",
            getStartedBtn: "شروع کریں",
            disclaimerTitle: "ڈس کلیمر",
            disclaimerMsg1: "اسناد راوی ایکسپلورر ایپلیکیشن میں پیش کردہ ڈیٹا معلوماتی اور تحقیقی مقاصد کے لیے مختلف ذرائع سے مرتب کیا گیا ہے۔ اگرچہ درستگی کو یقینی بنانے کی کوششیں کی گئی ہیں، معلومات میں غلطیاں، کوتاہیاں، یا مخصوص علمی تشریحات کی عکاسی ہو سکتی ہے۔",
            disclaimerMsg2: "صارفین کو سختی سے مشورہ دیا جاتا ہے کہ وہ اصل ماخذ مواد سے رجوع کریں اور معلومات کی آزادانہ طور پر تصدیق کریں، خاص طور پر جب علمی تحقیق کر رہے ہوں یا مذہبی تعینات کر رہے ہوں۔",
            disclaimerMsg3: "ایپلیکیشن صارف کے تیار کردہ تمام ڈیٹا (نوٹس، بک مارکس، زمرے) کو صارف کے براؤزر میں IndexedDB کے ذریعے مقامی طور پر اسٹور کرتی ہے۔ کوئی ذاتی ڈیٹا اکٹھا یا بیرونی سرورز کو منتقل نہیں کیا جاتا ہے۔ صارف فراہم کردہ ایکسپورٹ فیچر کا استعمال کرتے ہوئے اپنے مقامی ڈیٹا کا بیک اپ لینے کا مکمل طور پر ذمہ دار ہے۔",
            closeBtn: "بند کریں",
            noteModalTitle: "نوٹ شامل/ترمیم کریں",
            noteLabel: "نوٹ:",
            notePlaceholder: "اپنا نوٹ یہاں درج کریں...",
            saveBtn: "محفوظ کریں",
            deleteBtn: "حذف کریں",
            categoryModalTitle: "نیا زمرہ شامل کریں",
            categoryNameLabel: "زمرہ کا نام:",
            categoryNamePlaceholder: "زمرہ کا نام درج کریں...",
            backToList: "→ فہرست پر واپس",
            details: "تفصیلات",
            relationships: "تعلقات",
            teachers: "اساتذہ",
            students: "طلباء",
            family: "خاندان",
            parents: "والدین",
            spouse: "ازواج",
            siblings: "بہن بھائی",
            children: "اولاد",
            lifeEvents: "زندگی اور مقامات",
            birth: "پیدائش",
            death: "وفات",
            placesOfStay: "قیام کی جگہیں",
            areaOfInterest: "دلچسپی کا شعبہ",
            tags: "ٹیگز",
            books: "کتابیں",
            userNotes: "آپ کے نوٹس",
            noNote: "ابھی تک کوئی نوٹ شامل نہیں کیا گیا۔",
            editNoteBtn: "نوٹ میں ترمیم کریں",
            addNoteBtn: "نوٹ شامل کریں",
            infographics: "انفوگرافکس",
            lifespan: "عمر (تقریباً)",
            years: "سال",
            numTeachers: "اساتذہ",
            numStudents: "طلباء",
            loading: "لوڈ ہو رہا ہے...",
            error: "خرابی",
            success: "کامیابی",
            importSuccess: "ڈیٹا کامیابی سے درآمد ہو گیا!",
            importError: "ڈیٹا درآمد کرنے میں خرابی۔ یقینی بنائیں کہ فائل درست JSON ہے۔",
            exportError: "ڈیٹا برآمد کرنے میں خرابی۔",
            dbError: "ڈیٹا بیس میں خرابی پیش آگئی۔",
            parseError: "ابتدائی ڈیٹا کو پارس کرنے یا حاصل کرنے میں خرابی۔", // Updated message
            confirmImport: "یہ تمام موجودہ ڈیٹا کو بدل دے گا۔ کیا آپ کو یقین ہے؟",
            confirmCatDelete: "زمرہ '{catName}' حذف کریں؟ اس زمرے کے راوی غیر زمرہ بند ہو جائیں گے۔",
            selectCategories: "زمرے منتخب کریں",
            noCategories: "ابھی تک کوئی زمرہ نہیں بنایا گیا۔",
            category: "زمرہ",
            unassigned: "غیر تفویض شدہ",
            assignCategory: "زمرہ تفویض کریں",
            removeCategory: "زمرہ ہٹائیں",
            deleteCategory: "زمرہ حذف کریں",
            prevPage: "‹ پچھلا",
            nextPage: "اگلا ›",
            pageInfo: "صفحہ {currentPage} از {totalPages}",
        }
    };

    // --- Utility Functions ---
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    const showLoading = () => $('#loading-overlay')?.classList.add('show');
    const hideLoading = () => $('#loading-overlay')?.classList.remove('show');
    const showModal = (id) => $(`#${id}`)?.classList.add('show');
    const closeModal = (id) => $(`#${id}`)?.classList.remove('show');

    function showAlert(message, type = 'info') {
        // Simple alert for now, can be replaced with a styled notification
        console.log(`${type.toUpperCase()}: ${message}`);
        // TODO: Implement a more user-friendly notification system if desired
    }

    function applyTranslations(lang) {
        const htmlEl = document.documentElement;
        htmlEl.lang = lang;
        htmlEl.dir = lang === 'ur' ? 'rtl' : 'ltr';
        currentSettings.language = lang;
        saveSettings();

        $$('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang]?.[key]) {
                el.innerHTML = translations[lang][key]; // Use innerHTML for keys with HTML (like onboardingMsg2)
            } else if (translations.en?.[key]) {
                 el.innerHTML = translations.en[key]; // Fallback to English
            }
        });
         $$('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (translations[lang]?.[key]) {
                el.placeholder = translations[lang][key];
            } else if (translations.en?.[key]) {
                 el.placeholder = translations.en[key]; // Fallback to English
            }
        });

         // Update language toggle button text
         const langToggleBtn = $('#language-toggle');
         if(langToggleBtn) langToggleBtn.textContent = translations[lang]?.langToggle || translations.en.langToggle;

         // Re-render UI elements that might have language-specific content
         // Render current page only, applyFilters handles this
         applyFilters(); // Re-apply filters to re-render list and pagination with new text
         if (!$('#narrator-detail-view')?.classList.contains('hidden')) {
             const currentId = $('#narrator-detail-view')?.dataset.narratorId;
             if (currentId) {
                 displayNarratorDetails(parseInt(currentId)); // Re-render details view
             }
         }
         renderCategories(); // Re-render category pills
    }

    function toggleLanguage() {
        const newLang = currentSettings.language === 'en' ? 'ur' : 'en';
        applyTranslations(newLang);
    }

    function applyTheme(theme) {
        document.body.classList.toggle('dark-theme', theme === 'dark');
        currentSettings.theme = theme;
        saveSettings();
        const themeToggleBtn = $('#theme-toggle');
        if(themeToggleBtn) themeToggleBtn.textContent = theme === 'dark' ? '☀️' : '🌙'; // Update icon
    }

    function toggleTheme() {
        const newTheme = currentSettings.theme === 'light' ? 'dark' : 'light';
        applyTheme(newTheme);
    }

    function saveSettings() {
        try {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
        } catch (e) {
            console.error("Error saving settings to localStorage:", e);
            showAlert(i18n('error') + ": Could not save settings.", 'error');
        }
    }

    function loadSettings() {
        try {
            const savedSettings = localStorage.getItem(SETTINGS_KEY);
            if (savedSettings) {
                currentSettings = JSON.parse(savedSettings);
            } else {
                 const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                 currentSettings.theme = prefersDark ? 'dark' : 'light';
                 // Default language 'en'
                 currentSettings.language = 'en';
            }
        } catch (e) {
            console.error("Error loading settings from localStorage:", e);
            currentSettings = { theme: 'light', language: 'en' };
        }
        // Apply theme and language based on loaded/default settings
        applyTheme(currentSettings.theme);
        // Translations will be applied later during initialization after DOM is ready
    }

    function markOnboardingComplete() {
         try {
            localStorage.setItem(ONBOARDING_KEY, 'true');
        } catch (e) {
             console.error("Error saving onboarding status:", e);
        }
    }

    function isOnboardingComplete() {
         try {
            return localStorage.getItem(ONBOARDING_KEY) === 'true';
        } catch (e) {
             console.error("Error reading onboarding status:", e);
             return false; // Assume not complete if error
        }
    }

    function i18n(key, replacements = {}) {
        let text = translations[currentSettings.language]?.[key] || translations.en[key] || `[${key}]`;
        for (const placeholder in replacements) {
            // Use a regex for global replacement
            const regex = new RegExp(`\\{${placeholder}\\}`, 'g');
            text = text.replace(regex, replacements[placeholder]);
        }
        return text;
    }

    // --- IndexedDB Operations ---
    function openDB() {
        return new Promise((resolve, reject) => {
            if (!window.indexedDB) {
                reject("IndexedDB not supported by this browser.");
                return;
            }
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onupgradeneeded = (event) => {
                const dbInstance = event.target.result;
                if (!dbInstance.objectStoreNames.contains(STORE_NARRATORS)) {
                    const narratorStore = dbInstance.createObjectStore(STORE_NARRATORS, { keyPath: 'scholar_indx' });
                    narratorStore.createIndex('name', 'name', { unique: false });
                    narratorStore.createIndex('grade', 'grade', { unique: false });
                    narratorStore.createIndex('tags', 'tags', { multiEntry: true });
                    narratorStore.createIndex('categories', 'categories', { multiEntry: true });
                }
                if (!dbInstance.objectStoreNames.contains(STORE_NOTES)) {
                    dbInstance.createObjectStore(STORE_NOTES, { keyPath: 'narratorId' });
                }
                if (!dbInstance.objectStoreNames.contains(STORE_BOOKMARKS)) {
                     dbInstance.createObjectStore(STORE_BOOKMARKS); // Store ID as key and value
                }
                 if (!dbInstance.objectStoreNames.contains(STORE_CATEGORIES)) {
                    dbInstance.createObjectStore(STORE_CATEGORIES, { keyPath: 'id', autoIncrement: false });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };

            request.onerror = (event) => {
                console.error("Database error:", event.target.errorCode, event.target.error);
                reject(i18n('dbError') + `: ${event.target.error}`);
            };
        });
    }

    function performDBTransaction(storeName, mode, operation) {
        return new Promise((resolve, reject) => {
            if (!db) {
                reject("Database not initialized.");
                return;
            }
            try {
                const transaction = db.transaction(storeName, mode);
                const store = transaction.objectStore(storeName);
                operation(store, resolve, reject); // Pass store, resolve, reject to the operation callback

                transaction.oncomplete = () => {
                   // console.log(`Transaction complete for ${storeName}`);
                };
                transaction.onerror = (event) => {
                    console.error(`Transaction error on ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            } catch (error) {
                 console.error(`Error starting transaction on ${storeName}:`, error);
                 reject(error);
            }
        });
    }

    function addData(storeName, data) {
        return performDBTransaction(storeName, 'readwrite', (store, resolve, reject) => {
            const request = store.put(data);
            request.onsuccess = () => resolve(request.result);
            request.onerror = (e) => reject(e.target.error);
        });
    }

    function addBulkData(storeName, dataArray) {
         return performDBTransaction(storeName, 'readwrite', (store, resolve, reject) => {
            let count = 0;
            const total = dataArray.length;
            if (total === 0) {
                resolve();
                return;
            }
            let errors = [];
            dataArray.forEach(item => {
                const request = store.put(item);
                request.onsuccess = () => {
                    count++;
                    if (count === total) {
                        errors.length > 0 ? reject(errors) : resolve();
                    }
                };
                request.onerror = (e) => {
                    console.error(`Error adding item to ${storeName}:`, item, e.target.error);
                    errors.push({ item: item, error: e.target.error });
                    count++;
                     if (count === total) {
                        reject(errors); // Reject with accumulated errors
                    }
                };
            });
        });
    }

    function getData(storeName, key) {
        return performDBTransaction(storeName, 'readonly', (store, resolve, reject) => {
            const request = store.get(key);
            request.onsuccess = () => resolve(request.result);
            request.onerror = (e) => reject(e.target.error);
        });
    }

    function getAllData(storeName) {
        return performDBTransaction(storeName, 'readonly', (store, resolve, reject) => {
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = (e) => reject(e.target.error);
        });
    }

     function deleteData(storeName, key) {
        return performDBTransaction(storeName, 'readwrite', (store, resolve, reject) => {
            const request = store.delete(key);
            request.onsuccess = () => resolve();
            request.onerror = (e) => reject(e.target.error);
        });
    }

    function clearStore(storeName) {
         return performDBTransaction(storeName, 'readwrite', (store, resolve, reject) => {
            const request = store.clear();
            request.onsuccess = () => resolve();
            request.onerror = (e) => reject(e.target.error);
        });
    }

    // --- Data Parsing and Processing ---
    function parseCSV(csvString) {
        const lines = csvString.trim().split('\n');
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim());
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = [];
            let currentVal = '';
            let inQuotes = false;
            const line = lines[i];
            for (let j = 0; j < line.length; j++) {
                const char = line[j];
                if (char === '"' && (j === 0 || line[j-1] !== '\\')) {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(currentVal.trim().replace(/^"|"$/g, ''));
                    currentVal = '';
                } else {
                    currentVal += char;
                }
            }
            values.push(currentVal.trim().replace(/^"|"$/g, ''));
            if (values.length === headers.length) {
                const entry = {};
                headers.forEach((header, index) => {
                    entry[header] = values[index] !== 'NA' ? values[index] : null;
                });
                data.push(entry);
            } else {
                 console.warn(`Skipping malformed CSV line ${i + 1}: Expected ${headers.length} fields, found ${values.length}`);
            }
        }
        return data;
    }

    function extractIds(text) {
        if (!text || typeof text !== 'string') return [];
        const matches = text.match(/\[(\d+)\]/g);
        return matches ? matches.map(m => parseInt(m.replace(/\[|\]/g, ''))) : [];
    }

    function processNarratorData(narrator) {
        const processed = { ...narrator };
        processed.scholar_indx = parseInt(narrator.scholar_indx, 10);
        processed.teacherIds = extractIds(narrator.teachers);
        processed.studentIds = extractIds(narrator.students);
        processed.parentIds = extractIds(narrator.parents);
        processed.spouseIds = extractIds(narrator.spouse);
        processed.siblingIds = extractIds(narrator.siblings);
        processed.childrenIds = extractIds(narrator.children);
        processed.tags = narrator.tags ? narrator.tags.split(' , ').map(tag => {
            try {
                const tagNameMatch = tag.match(/^([^\[]+)/);
                return tagNameMatch ? decodeURIComponent(tagNameMatch[1].trim()) : decodeURIComponent(tag.trim());
            } catch (e) {
                console.warn("Failed to decode tag:", tag);
                return tag.trim();
            }
        }) : [];
         processed.areasOfInterest = narrator.area_of_interest ? narrator.area_of_interest.split(',').map(a => a.trim()) : [];
         processed.categories = []; // Initialize empty, user assigns later
         processed.birth_year_hijri = narrator.birth_date_hijri ? parseInt(narrator.birth_date_hijri) : null;
         processed.birth_year_gregorian = narrator.birth_date_gregorian ? parseInt(narrator.birth_date_gregorian) : null;
         processed.death_year_hijri = narrator.death_date_hijri ? parseInt(narrator.death_date_hijri) : null;
         processed.death_year_gregorian = narrator.death_date_gregorian ? parseInt(narrator.death_date_gregorian) : null;
         if (processed.birth_year_gregorian && processed.death_year_gregorian) {
             processed.lifespan_gregorian = processed.death_year_gregorian - processed.birth_year_gregorian;
         } else {
             processed.lifespan_gregorian = null;
         }
         return processed;
    }

    // --- Initial Data Loading (from external CSV) ---
    async function loadInitialData() {
        showLoading();
        try {
            // Fetch the CSV data from the specified path
            const response = await fetch(CSV_FILE_PATH);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} - Could not fetch ${CSV_FILE_PATH}`);
            }
            const csvText = await response.text();
            if (!csvText) {
                 throw new Error("Fetched CSV file is empty.");
            }

            const parsedData = parseCSV(csvText);
            if (!parsedData || parsedData.length === 0) {
                 throw new Error("CSV data is empty or could not be parsed.");
            }
            const processedNarrators = parsedData.map(processNarratorData);

            // Add to DB
            await addBulkData(STORE_NARRATORS, processedNarrators);
            console.log(`Stored ${processedNarrators.length} initial narrators from ${CSV_FILE_PATH}.`);

            // Load all data (including the newly added) into memory
            await loadAllDataFromDB();

            showAlert(i18n('success') + ": Initial data loaded.", 'success');
        } catch (error) {
            console.error("Error loading initial data:", error);
            showAlert(i18n('parseError') + `: ${error.message}`, 'error');
            const mainContent = $('#main-content-area');
            if(mainContent) mainContent.innerHTML = `<p class="text-danger bold">${i18n('error')}: Could not load initial narrator data from ${CSV_FILE_PATH}. Please ensure the file exists and is accessible. Error: ${error.message}</p>`;
        } finally {
            hideLoading();
        }
    }

    // --- Load All Data from IndexedDB ---
    async function loadAllDataFromDB() {
         showLoading();
         try {
             const [narrators, notes, bookmarks, categories] = await Promise.all([
                 getAllData(STORE_NARRATORS),
                 getAllData(STORE_NOTES),
                 getAllData(STORE_BOOKMARKS),
                 getAllData(STORE_CATEGORIES)
             ]);

             allNarratorsData = narrators || [];
             // Sort narrators once after loading (e.g., by ID or name) if desired
             allNarratorsData.sort((a, b) => a.scholar_indx - b.scholar_indx);

             allNotes = (notes || []).reduce((acc, note) => {
                 acc[note.narratorId] = note.text;
                 return acc;
             }, {});

             allBookmarks = new Set(bookmarks || []);

             allCategories = categories || [];
             allCategories.sort((a, b) => a.name.localeCompare(b.name));

             console.log(`Loaded ${allNarratorsData.length} narrators, ${Object.keys(allNotes).length} notes, ${allBookmarks.size} bookmarks, ${allCategories.length} categories.`);

             // Populate UI elements
             populateGradeFilter(allNarratorsData);
             renderCategories();
             currentPage = 1; // Reset to page 1 after loading all data
             applyFilters(); // Apply default/current filters and render first page

         } catch (error) {
             console.error("Error loading data from DB:", error);
             showAlert(i18n('dbError'), 'error');
             allNarratorsData = [];
             filteredNarrators = [];
             currentNarrators = [];
             allNotes = {};
             allBookmarks = new Set();
             allCategories = [];
             renderNarratorList([]); // Show empty list
             populateGradeFilter([]);
             renderCategories();
             renderPaginationControls(); // Ensure pagination controls are cleared/hidden
         } finally {
             hideLoading();
         }
    }

    // --- UI Rendering ---
    function populateGradeFilter(narrators) {
        const gradeFilter = $('#filter-grade');
        if (!gradeFilter) return;
        const currentVal = gradeFilter.value; // Preserve selection if possible
        while (gradeFilter.options.length > 1) {
            gradeFilter.remove(1);
        }
        const grades = new Set(narrators.map(n => n.grade).filter(Boolean));
        const sortedGrades = Array.from(grades).sort();
        sortedGrades.forEach(grade => {
            const option = document.createElement('option');
            option.value = grade;
            option.textContent = grade;
            gradeFilter.appendChild(option);
        });
        gradeFilter.value = currentVal; // Restore selection
    }

    function renderNarratorList(narratorsToRender) {
        const listContainer = $('#narrator-list');
        const noResultsMsg = $('#no-results-message'); // Assumes it's outside listContainer now

        if (!listContainer || !noResultsMsg) {
            console.error("Narrator list or no-results message container not found.");
            return;
        }

        listContainer.innerHTML = ''; // Clear previous page's list

        if (!narratorsToRender || narratorsToRender.length === 0) {
            noResultsMsg.classList.remove('hidden');
            return;
        }

        noResultsMsg.classList.add('hidden');
        const fragment = document.createDocumentFragment();

        narratorsToRender.forEach(narrator => {
            const card = document.createElement('div');
            card.className = 'narrator-card';
            card.dataset.id = narrator.scholar_indx;
            card.onclick = (e) => {
                 if (e.target.closest('button')) return;
                 displayNarratorDetails(narrator.scholar_indx);
            };

            const isBookmarked = allBookmarks.has(narrator.scholar_indx);
            const hasNote = !!allNotes[narrator.scholar_indx];

            card.innerHTML = `
                <h3>${narrator.name || 'Unnamed Narrator'}</h3>
                <p>${narrator.grade || 'N/A'}</p>
                ${narrator.tags && narrator.tags.length > 0 ? `<div class="tags">${narrator.tags.slice(0, 5).map(tag => `<span>${tag}</span>`).join('')} ${narrator.tags.length > 5 ? '...' : ''}</div>` : ''}
                <div class="actions">
                    <button class="button button-icon ${isBookmarked ? 'bookmarked' : ''}" onclick="toggleBookmark(event, ${narrator.scholar_indx})" title="${isBookmarked ? i18n('unbookmark') : i18n('bookmark')}">
                       ${isBookmarked ? '★' : '☆'}
                    </button>
                     <button class="button button-icon" onclick="openNoteModal(event, ${narrator.scholar_indx})" title="${hasNote ? i18n('editNote') : i18n('addNote')}">
                       📝
                     </button>
                     <button class="button button-icon" onclick="openCategoryAssignModal(event, ${narrator.scholar_indx})" title="${i18n('categorize')}">
                        🏷️
                     </button>
                </div>
            `;
            fragment.appendChild(card);
        });

        listContainer.appendChild(fragment);
    }

    function renderRelationshipList(ids, titleKey) {
         if (!ids || ids.length === 0) return `<p>N/A</p>`;
         let html = `<h4>${i18n(titleKey)}</h4><ul>`;
         ids.forEach(id => {
             const relatedNarrator = allNarratorsData.find(n => n.scholar_indx === id);
             if (relatedNarrator) {
                 html += `<li><a href="#" class="link" onclick="event.preventDefault(); displayNarratorDetails(${id})">${relatedNarrator.name}</a></li>`;
             }
         });
         html += `</ul>`;
         return html;
    }

    function renderTree(narratorId, type) {
        const container = document.createElement('div');
        container.className = 'tree';
        const rootUl = document.createElement('ul');
        container.appendChild(rootUl);
        const visited = new Set();

        function buildBranch(id, level = 0, maxLevel = 3) {
            if (level > maxLevel || visited.has(id)) return null;
            visited.add(id);
            const narrator = allNarratorsData.find(n => n.scholar_indx === id);
            if (!narrator) {
                visited.delete(id); // Remove from visited if not found
                return null;
            }

            const li = document.createElement('li');
            if (id === narratorId) li.classList.add('current-node');
            const span = document.createElement('span');
            span.textContent = narrator.name;
            span.onclick = () => displayNarratorDetails(id);
            li.appendChild(span);

            const relatedIds = (type === 'teachers' ? narrator.teacherIds : narrator.studentIds) || [];
            if (relatedIds.length > 0 && level < maxLevel) { // Check level before recursing
                const ul = document.createElement('ul');
                let hasChildren = false;
                relatedIds.forEach(relatedId => {
                    const branch = buildBranch(relatedId, level + 1, maxLevel);
                    if (branch) {
                        ul.appendChild(branch);
                        hasChildren = true;
                    }
                });
                if (hasChildren) li.appendChild(ul);
            }
            // visited.delete(id); // Keep visited to prevent cycles within maxLevel
            return li;
        }

        const rootBranch = buildBranch(narratorId);
        if (rootBranch) {
            rootUl.appendChild(rootBranch);
            return container;
        }
        return null;
    }

    function displayNarratorDetails(id) {
        showLoading();
        const narrator = allNarratorsData.find(n => n.scholar_indx === id);
        const detailView = $('#narrator-detail-view');
        const listView = $('#narrator-list-view');

        if (!narrator || !detailView || !listView) {
            showAlert(i18n('error') + ": Narrator not found or UI elements missing.", 'error');
            hideLoading();
            return;
        }

        let detailsHtml = `
            <button class="button button-secondary mb-2" onclick="showListView()"><span aria-hidden="true">${i18n('backToList')}</span></button>
            <h2>${narrator.name}</h2>

            <div class="detail-section">
                <h4>${i18n('details')}</h4>
                <p><strong>ID:</strong> ${narrator.scholar_indx}</p>
                <p><strong>${i18n('grade')}:</strong> ${narrator.grade || 'N/A'}</p>
                ${narrator.categories && narrator.categories.length > 0 ? `
                    <p><strong>${i18n('category')}:</strong> ${narrator.categories.map(catId => {
                        const cat = allCategories.find(c => c.id === catId);
                        return cat ? `<span class="category-pill" style="cursor:default; background-color: var(--accent-color);">${cat.name}</span>` : '';
                    }).join(' ')}
                    </p>
                ` : ''}
            </div>`;

         // Infographics
         detailsHtml += `<div class="detail-section"><h4>${i18n('infographics')}</h4><div class="infographics">`;
         if (narrator.lifespan_gregorian) {
             detailsHtml += `<div class="info-card"><div class="value">${narrator.lifespan_gregorian}</div><div class="label">${i18n('lifespan')} (${i18n('years')})</div></div>`;
         }
         if (narrator.teacherIds) {
              detailsHtml += `<div class="info-card"><div class="value">${narrator.teacherIds.length}</div><div class="label">${i18n('numTeachers')}</div></div>`;
         }
          if (narrator.studentIds) {
              detailsHtml += `<div class="info-card"><div class="value">${narrator.studentIds.length}</div><div class="label">${i18n('numStudents')}</div></div>`;
         }
         detailsHtml += `</div></div>`;

        // Relationships
        detailsHtml += `<div class="detail-section"><h4>${i18n('relationships')}</h4>`;
        detailsHtml += `<div class="mb-1">${renderRelationshipList(narrator.parentIds, 'parents')}</div>`;
        detailsHtml += `<div class="mb-1">${renderRelationshipList(narrator.spouseIds, 'spouse')}</div>`;
        detailsHtml += `<div class="mb-1">${renderRelationshipList(narrator.siblingIds, 'siblings')}</div>`;
        detailsHtml += `<div class="mb-1">${renderRelationshipList(narrator.childrenIds, 'children')}</div>`;
        detailsHtml += `</div>`;

        // Teacher/Student Trees
         const teacherTreeContainer = document.createElement('div');
         teacherTreeContainer.className = 'detail-section tree-container'; // Added tree-container class
         teacherTreeContainer.innerHTML = `<h4>${i18n('teachers')}</h4>`;
         const teacherTree = renderTree(id, 'teachers');
         teacherTree ? teacherTreeContainer.appendChild(teacherTree) : teacherTreeContainer.innerHTML += `<p>N/A</p>`;
         detailsHtml += teacherTreeContainer.outerHTML;

         const studentTreeContainer = document.createElement('div');
         studentTreeContainer.className = 'detail-section tree-container'; // Added tree-container class
         studentTreeContainer.innerHTML = `<h4>${i18n('students')}</h4>`;
         const studentTree = renderTree(id, 'students');
         studentTree ? studentTreeContainer.appendChild(studentTree) : studentTreeContainer.innerHTML += `<p>N/A</p>`;
         detailsHtml += studentTreeContainer.outerHTML;

        // Life Events & Places
        detailsHtml += `<div class="detail-section">
                <h4>${i18n('lifeEvents')}</h4>
                <p><strong>${i18n('birth')}:</strong> ${narrator.birth_date_place || 'N/A'}</p>
                <p><strong>${i18n('death')}:</strong> ${narrator.death_date_place || 'N/A'}</p>
                <p><strong>${i18n('placesOfStay')}:</strong> ${narrator.places_of_stay || 'N/A'}</p>
            </div>`;

        // Other Info
        detailsHtml += `<div class="detail-section">
                <h4>${i18n('areaOfInterest')}</h4>
                ${narrator.areasOfInterest && narrator.areasOfInterest.length > 0 ? `<ul>${narrator.areasOfInterest.map(a => `<li>${a}</li>`).join('')}</ul>` : '<p>N/A</p>'}
            </div>`;
        detailsHtml += `<div class="detail-section">
                <h4>${i18n('tags')}</h4>
                ${narrator.tags && narrator.tags.length > 0 ? `<div class="tags">${narrator.tags.map(tag => `<span>${tag}</span>`).join(' ')}</div>` : '<p>N/A</p>'}
            </div>`;
         detailsHtml += `<div class="detail-section">
                <h4>${i18n('books')}</h4>
                <p>${narrator.books || 'N/A'}</p>
            </div>`;

        // User Notes
        const noteText = allNotes[id];
        detailsHtml += `<div class="detail-section">
                <h4>${i18n('userNotes')}</h4>
                <div id="note-display-${id}">${noteText ? `<p>${noteText.replace(/\n/g, '<br>')}</p>` : `<p class="text-secondary">${i18n('noNote')}</p>`}</div>
                <button class="button button-secondary mt-1" onclick="openNoteModal(event, ${id})">
                    ${noteText ? i18n('editNoteBtn') : i18n('addNoteBtn')}
                </button>
            </div>`;

        detailView.innerHTML = detailsHtml;
        detailView.dataset.narratorId = id;
        listView.classList.add('hidden');
        detailView.classList.remove('hidden');
        window.scrollTo(0, 0);
        hideLoading();
    }

    function showListView() {
        const detailView = $('#narrator-detail-view');
        const listView = $('#narrator-list-view');
        if(detailView) {
            detailView.classList.add('hidden');
            detailView.innerHTML = '';
            detailView.removeAttribute('data-narrator-id');
        }
        if(listView) listView.classList.remove('hidden');
        // Optionally re-apply filters if needed, though usually not necessary when just going back
        // applyFilters();
    }

    // --- Filtering and Searching ---
    function applyFilters() {
        const searchTerm = currentFilters.search.toLowerCase().trim();
        const gradeFilter = currentFilters.grade;
        const categoryId = currentFilters.categoryId;

        let baseData = [...allNarratorsData]; // Start with all data

        // 1. Filter by Category/Bookmark first
        if (categoryId === 'bookmarked') {
            baseData = baseData.filter(n => allBookmarks.has(n.scholar_indx));
        } else if (categoryId !== 'all') {
             const catIdNum = parseInt(categoryId);
             baseData = baseData.filter(n => n.categories && n.categories.includes(catIdNum));
        }

        // 2. Filter by Grade
        if (gradeFilter) {
            baseData = baseData.filter(n => n.grade === gradeFilter);
        }

        // 3. Filter by Search Term
        if (searchTerm) {
            baseData = baseData.filter(n => {
                const nameMatch = n.name?.toLowerCase().includes(searchTerm);
                const tagMatch = n.tags?.some(tag => tag.toLowerCase().includes(searchTerm));
                const placeMatch = n.places_of_stay?.toLowerCase().includes(searchTerm) ||
                                   n.birth_place?.toLowerCase().includes(searchTerm) ||
                                   n.death_place?.toLowerCase().includes(searchTerm);
                const gradeMatch = n.grade?.toLowerCase().includes(searchTerm);
                return nameMatch || tagMatch || placeMatch || gradeMatch;
            });
        }

        // Store the full filtered list
         filteredNarrators = baseData;

    // Calculate the slice for the current page
    updateCurrentPageNarrators();
    renderNarratorList(currentNarrators); // Render only the current page's items
    renderPaginationControls(); //  MUST BE CALLED HERE
    }

    // --- Pagination ---
    function updateCurrentPageNarrators() {
        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        currentNarrators = filteredNarrators.slice(startIndex, endIndex);
    }

         function renderPaginationControls() {
            const controlsContainer = $('#pagination-controls');
            // Ensure the container exists before proceeding
            if (!controlsContainer) {
                console.error("Pagination controls container (#pagination-controls) not found in the DOM.");
                return;
            }
            controlsContainer.innerHTML = ''; // Clear previous controls

            const totalItems = filteredNarrators.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            // --- DEBUGGING LOG ---
            // console.log(`Rendering Pagination: totalItems=${totalItems}, totalPages=${totalPages}, currentPage=${currentPage}`);

            // Only render controls if there's more than one page
            if (totalPages <= 1) {
                // console.log("Pagination: Not rendering controls, totalPages <= 1");
                return; // No controls needed
            }

            const fragment = document.createDocumentFragment();

            // Previous Button
            const prevButton = document.createElement('button');
            prevButton.textContent = i18n('prevPage'); // Use translation
            prevButton.className = 'button button-secondary';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => changePage(currentPage - 1);
            prevButton.style.margin = '0 5px';
            fragment.appendChild(prevButton);

            // Page Info (e.g., "Page 2 of 10")
            const pageInfo = document.createElement('span');
            // Ensure i18n function correctly replaces placeholders
            pageInfo.textContent = i18n('pageInfo', { currentPage: currentPage, totalPages: totalPages });
            pageInfo.style.margin = '0 10px';
            pageInfo.style.verticalAlign = 'middle'; // Helps align text with buttons
            fragment.appendChild(pageInfo);

            // Next Button
            const nextButton = document.createElement('button');
            nextButton.textContent = i18n('nextPage'); // Use translation
            nextButton.className = 'button button-secondary';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => changePage(currentPage + 1);
            nextButton.style.margin = '0 5px';
            fragment.appendChild(nextButton);

            // Append the fragment with buttons and info to the container
            controlsContainer.appendChild(fragment);
            // console.log("Pagination: Controls rendered."); // Confirm rendering
        }

    function changePage(newPage) {
        const totalPages = Math.ceil(filteredNarrators.length / ITEMS_PER_PAGE);
        if (newPage < 1 || newPage > totalPages) {
            return; // Invalid page number
        }
        currentPage = newPage;
        updateCurrentPageNarrators(); // Get the data for the new page
        renderNarratorList(currentNarrators); // Render the new page's items
        renderPaginationControls(); // Update the controls
        window.scrollTo(0, 0); // Scroll to top
    }

    // --- Event Handlers for Filters ---
    function handleSearchInput(event) {
        currentFilters.search = event.target.value;
        currentPage = 1; // Reset page on new search
        applyFilters();
    }

    function handleGradeFilterChange(event) {
        currentFilters.grade = event.target.value;
        currentPage = 1; // Reset page on grade change
        applyFilters();
    }

    function handleCategoryFilterClick(categoryId) {
        // Only reset page if the category actually changes
        if (currentFilters.categoryId !== categoryId) {
             currentPage = 1; // Reset page on category change
             currentFilters.categoryId = categoryId;
        }
         // Update active state on pills
         $$('#category-pills-container .category-pill').forEach(pill => {
             pill.classList.toggle('active', pill.dataset.categoryId === categoryId.toString());
         });
        applyFilters();
    }

    // --- Bookmarks ---
    async function toggleBookmark(event, narratorId) {
        event.stopPropagation();
        const button = event.currentTarget;
        const isBookmarked = allBookmarks.has(narratorId);
        showLoading();
        try {
            if (isBookmarked) {
                await deleteData(STORE_BOOKMARKS, narratorId);
                allBookmarks.delete(narratorId);
                button.classList.remove('bookmarked');
                button.innerHTML = '☆';
                button.title = i18n('bookmark');
            } else {
                await addData(STORE_BOOKMARKS, narratorId); // Store ID as key and value
                allBookmarks.add(narratorId);
                button.classList.add('bookmarked');
                button.innerHTML = '★';
                 button.title = i18n('unbookmark');
            }
             // Refresh list if viewing bookmarks and page might change
             if (currentFilters.categoryId === 'bookmarked') {
                 const oldTotalPages = Math.ceil(filteredNarrators.length / ITEMS_PER_PAGE);
                 applyFilters(); // Re-apply filters which re-calculates filteredNarrators
                 const newTotalPages = Math.ceil(filteredNarrators.length / ITEMS_PER_PAGE);
                 // If the current page no longer exists, go to the last page
                 if (currentPage > newTotalPages) {
                     changePage(newTotalPages > 0 ? newTotalPages : 1);
                 }
             }
        } catch (error) {
            console.error("Error toggling bookmark:", error);
            showAlert(i18n('dbError'), 'error');
        } finally {
            hideLoading();
        }
    }

    // --- Notes ---
    function openNoteModal(event, narratorId) {
         event?.stopPropagation();
         const noteText = allNotes[narratorId] || '';
         const noteNarratorIdInput = $('#note-narrator-id');
         const noteTextInput = $('#note-text');
         const deleteNoteBtn = $('#delete-note-btn');

         if (!noteNarratorIdInput || !noteTextInput || !deleteNoteBtn) return;

         noteNarratorIdInput.value = narratorId;
         noteTextInput.value = noteText;
         deleteNoteBtn.classList.toggle('hidden', !noteText);
         showModal('note-modal');
         noteTextInput.focus();
    }

    async function saveNote() {
        const narratorIdInput = $('#note-narrator-id');
        const textInput = $('#note-text');
        if (!narratorIdInput || !textInput) return;

        const narratorId = parseInt(narratorIdInput.value);
        const text = textInput.value.trim();
        if (isNaN(narratorId)) return;

        showLoading();
        try {
            if (text) {
                const noteData = { narratorId: narratorId, text: text };
                await addData(STORE_NOTES, noteData);
                allNotes[narratorId] = text;
                showAlert(i18n('success') + ": Note saved.", 'success');
            } else {
                await deleteNoteInternal(narratorId); // Treat empty save as delete
            }
            closeModal('note-modal');
            updateNoteUI(narratorId, text); // Update UI elements
        } catch (error) {
            console.error("Error saving note:", error);
            showAlert(i18n('dbError'), 'error');
        } finally {
            hideLoading();
        }
    }

    async function deleteNote() {
         const narratorIdInput = $('#note-narrator-id');
         if (!narratorIdInput) return;
         const narratorId = parseInt(narratorIdInput.value);
         if (isNaN(narratorId)) return;

         showLoading();
         try {
             await deleteNoteInternal(narratorId);
             closeModal('note-modal');
             updateNoteUI(narratorId, ''); // Update UI after deletion
         } catch(error) {
             // Error already handled in deleteNoteInternal
         } finally {
             hideLoading();
         }
    }

    async function deleteNoteInternal(narratorId) {
         try {
             await deleteData(STORE_NOTES, narratorId);
             delete allNotes[narratorId];
             showAlert(i18n('success') + ": Note deleted.", 'success');
         } catch (error) {
             console.error("Error deleting note:", error);
             showAlert(i18n('dbError'), 'error');
             throw error; // Re-throw
         }
    }

    function updateNoteUI(narratorId, newText) {
        // Update note display if detail view is open
        const detailView = $('#narrator-detail-view');
        if (detailView && !detailView.classList.contains('hidden') && parseInt(detailView.dataset.narratorId) === narratorId) {
             const noteDisplay = $(`#note-display-${narratorId}`);
             if (noteDisplay) {
                 noteDisplay.innerHTML = newText ? `<p>${newText.replace(/\n/g, '<br>')}</p>` : `<p class="text-secondary">${i18n('noNote')}</p>`;
                 const button = detailView.querySelector(`button[onclick*="openNoteModal(event, ${narratorId})"]`);
                 if(button) button.textContent = newText ? i18n('editNoteBtn') : i18n('addNoteBtn');
             }
         }
         // Update note icon title on card in list view
         const cardButton = $(`#narrator-list .narrator-card[data-id="${narratorId}"] button[onclick*="openNoteModal"]`);
         if (cardButton) {
             cardButton.title = newText ? i18n('editNote') : i18n('addNote');
         }
    }

    // --- Categories ---
    function renderCategories() {
        const container = $('#category-pills-container');
        if (!container) return;

        // Clear existing user categories
        const userPills = container.querySelectorAll('.category-pill:not([data-category-id="all"]):not([data-category-id="bookmarked"])');
        userPills.forEach(pill => pill.remove());

        const fragment = document.createDocumentFragment();
        allCategories.forEach(cat => {
            const pill = document.createElement('button');
            pill.className = 'category-pill';
            pill.dataset.categoryId = cat.id;
            pill.textContent = cat.name;
            pill.onclick = () => handleCategoryFilterClick(cat.id);

            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'delete-cat';
            deleteBtn.innerHTML = '×';
            deleteBtn.title = i18n('deleteCategory');
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteCategory(cat.id, cat.name);
            };
            pill.appendChild(deleteBtn);
            fragment.appendChild(pill);
        });
        container.appendChild(fragment);

        // Re-apply active state
        $$('#category-pills-container .category-pill').forEach(pill => {
             pill.classList.toggle('active', pill.dataset.categoryId === currentFilters.categoryId.toString());
         });
    }

    function openAddCategoryModal() {
        const categoryNameInput = $('#category-name');
        if(categoryNameInput) categoryNameInput.value = '';
        showModal('category-modal');
        if(categoryNameInput) categoryNameInput.focus();
    }

    async function saveCategory() {
        const nameInput = $('#category-name');
        if (!nameInput) return;
        const name = nameInput.value.trim();
        if (!name) return;

        if (allCategories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
             showAlert(i18n('error') + ": Category name already exists.", 'warning');
             return;
        }

        const newCategory = { id: Date.now(), name: name };
        showLoading();
        try {
            await addData(STORE_CATEGORIES, newCategory);
            allCategories.push(newCategory);
            allCategories.sort((a, b) => a.name.localeCompare(b.name));
            renderCategories();
            closeModal('category-modal');
            showAlert(i18n('success') + ": Category added.", 'success');
        } catch (error) {
            console.error("Error saving category:", error);
            showAlert(i18n('dbError'), 'error');
        } finally {
            hideLoading();
        }
    }

    async function deleteCategory(categoryId, categoryName) {
        if (!confirm(i18n('confirmCatDelete', { catName: categoryName }))) return;
        showLoading();
        try {
            // Delete category itself
            await deleteData(STORE_CATEGORIES, categoryId);

            // Remove category ID from narrators (both in memory and DB)
            const narratorsToUpdate = [];
            allNarratorsData.forEach(narrator => {
                if (narrator.categories?.includes(categoryId)) {
                    narrator.categories = narrator.categories.filter(cId => cId !== categoryId);
                    narratorsToUpdate.push(narrator); // Collect narrators that need DB update
                }
            });
            // Update narrators in DB (can be slow for many, consider batching if needed)
            for (const narrator of narratorsToUpdate) {
                 await addData(STORE_NARRATORS, narrator);
            }

            // Update local state
            allCategories = allCategories.filter(cat => cat.id !== categoryId);

            // Re-render UI
            renderCategories();
             if (currentFilters.categoryId === categoryId) {
                 handleCategoryFilterClick('all'); // Switch to 'All' if deleted category was active
             } else {
                 applyFilters(); // Re-apply filters as narrator category status might have changed
             }
             // Refresh detail view if open and affected
             const detailView = $('#narrator-detail-view');
             if (detailView && !detailView.classList.contains('hidden')) {
                 const detailViewId = parseInt(detailView.dataset.narratorId);
                 if (narratorsToUpdate.some(n => n.scholar_indx === detailViewId)) {
                     displayNarratorDetails(detailViewId);
                 }
             }
            showAlert(i18n('success') + ": Category deleted.", 'success');
        } catch (error) {
            console.error("Error deleting category:", error);
            showAlert(i18n('dbError'), 'error');
        } finally {
            hideLoading();
        }
    }

    // --- Assigning Categories ---
    function openCategoryAssignModal(event, narratorId) {
        event.stopPropagation();
        const narrator = allNarratorsData.find(n => n.scholar_indx === narratorId);
        if (!narrator) return;

        const modalId = 'assign-category-modal';
        let modal = $(`#${modalId}`);
        // Create modal dynamically if it doesn't exist
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal('${modalId}')">×</span>
                    <h2 data-i18n="selectCategories">${i18n('selectCategories')}</h2>
                    <input type="hidden" id="assign-cat-narrator-id">
                    <div id="assign-category-list" class="form-group" style="max-height: 300px; overflow-y: auto;"></div>
                    <button id="save-assigned-categories-btn" class="button button-success" data-i18n="saveBtn">${i18n('saveBtn')}</button>
                </div>`;
            document.body.appendChild(modal);
            // Apply translations if needed
            if (currentSettings.language !== 'en') {
                 modal.querySelectorAll('[data-i18n]').forEach(el => {
                     const key = el.getAttribute('data-i18n');
                     if (translations[currentSettings.language]?.[key]) {
                         el.textContent = translations[currentSettings.language][key];
                     }
                 });
             }
        }

        const narratorIdInput = $('#assign-cat-narrator-id');
        const categoryListDiv = $('#assign-category-list');
        const saveBtn = $('#save-assigned-categories-btn');

        if (!narratorIdInput || !categoryListDiv || !saveBtn) return;

        narratorIdInput.value = narratorId;
        categoryListDiv.innerHTML = ''; // Clear previous
        const currentCatIds = narrator.categories || [];

        if (allCategories.length === 0) {
            categoryListDiv.innerHTML = `<p data-i18n="noCategories">${i18n('noCategories')}</p>`;
        } else {
            allCategories.forEach(cat => {
                const isChecked = currentCatIds.includes(cat.id);
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input type="checkbox" id="cat-check-${cat.id}" value="${cat.id}" ${isChecked ? 'checked' : ''} style="margin-inline-end: 5px;">
                    <label for="cat-check-${cat.id}">${cat.name}</label>
                `;
                categoryListDiv.appendChild(div);
            });
        }

        saveBtn.onclick = saveAssignedCategories;
        showModal(modalId);
    }

    async function saveAssignedCategories() {
        const narratorIdInput = $('#assign-cat-narrator-id');
        if (!narratorIdInput) return;
        const narratorId = parseInt(narratorIdInput.value);
        if (isNaN(narratorId)) return;

        const selectedCategoryIds = [];
        $$('#assign-category-list input[type="checkbox"]:checked').forEach(checkbox => {
            selectedCategoryIds.push(parseInt(checkbox.value));
        });

        showLoading();
        try {
            await updateNarratorCategories(narratorId, selectedCategoryIds);
            closeModal('assign-category-modal');
        } catch (error) {
             console.error("Error assigning categories:", error);
             showAlert(i18n('dbError'), 'error');
        } finally {
             hideLoading();
        }
    }

    async function updateNarratorCategories(narratorId, newCategoryIds) {
         const narratorIndex = allNarratorsData.findIndex(n => n.scholar_indx === narratorId);
         if (narratorIndex === -1) throw new Error("Narrator not found in local data");

         const narrator = allNarratorsData[narratorIndex];
         narrator.categories = newCategoryIds; // Update local object
         await addData(STORE_NARRATORS, narrator); // Update in DB

         // Re-apply filters if a category filter is active
         if (currentFilters.categoryId !== 'all' && currentFilters.categoryId !== 'bookmarked') {
             applyFilters();
         }
         // Refresh detail view if open
         const detailView = $('#narrator-detail-view');
         if (detailView && !detailView.classList.contains('hidden') && parseInt(detailView.dataset.narratorId) === narratorId) {
             displayNarratorDetails(narratorId);
         }
         showAlert(i18n('success') + ": Categories updated.", 'success');
    }

    // --- Backup and Restore ---
    async function exportData() {
        showLoading();
        try {
            const [narrators, notes, bookmarks, categories] = await Promise.all([
                getAllData(STORE_NARRATORS),
                getAllData(STORE_NOTES),
                getAllData(STORE_BOOKMARKS),
                getAllData(STORE_CATEGORIES)
            ]);

            const backupData = {
                version: 1,
                exportedAt: new Date().toISOString(),
                narrators: narrators || [],
                notes: notes || [],
                bookmarks: bookmarks || [],
                categories: categories || []
            };

            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().slice(0, 10);
            a.download = `isnad_explorer_backup_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showAlert(i18n('success') + ": Data exported successfully.", 'success');
        } catch (error) {
            console.error("Error exporting data:", error);
            showAlert(i18n('exportError'), 'error');
        } finally {
            hideLoading();
        }
    }

    function triggerImport() {
        if (!confirm(i18n('confirmImport'))) return;
        const importInput = $('#import-data-input');
        if(importInput) importInput.click();
    }

    async function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        showLoading();
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const backupData = JSON.parse(e.target.result);
                if (!backupData || typeof backupData !== 'object' || !backupData.narrators || !backupData.notes || !backupData.bookmarks || !backupData.categories) {
                    throw new Error("Invalid backup file format.");
                }

                // Clear existing data
                await Promise.all([
                    clearStore(STORE_NARRATORS),
                    clearStore(STORE_NOTES),
                    clearStore(STORE_BOOKMARKS),
                    clearStore(STORE_CATEGORIES)
                ]);

                // Import new data
                await Promise.all([
                    addBulkData(STORE_NARRATORS, backupData.narrators),
                    addBulkData(STORE_NOTES, backupData.notes),
                    performDBTransaction(STORE_BOOKMARKS, 'readwrite', (store, resolve, reject) => {
                         let count = 0;
                         const total = backupData.bookmarks.length;
                         if (total === 0) resolve();
                         else {
                             backupData.bookmarks.forEach(id => {
                                 const req = store.put(id, id); // Store ID as key and value
                                 req.onsuccess = () => { count++; if (count === total) resolve(); };
                                 req.onerror = (err) => { console.error("Bookmark import error:", err); count++; if (count === total) resolve(); }; // Continue on error
                             });
                         }
                     }),
                    addBulkData(STORE_CATEGORIES, backupData.categories)
                ]);

                // Reload all data from DB and refresh UI
                await loadAllDataFromDB();
                showAlert(i18n('importSuccess'), 'success');

            } catch (error) {
                console.error("Error importing data:", error);
                showAlert(i18n('importError') + `: ${error.message}`, 'error');
                await loadAllDataFromDB(); // Try to reload whatever state DB is in
            } finally {
                hideLoading();
                event.target.value = null; // Reset file input
            }
        };
        reader.onerror = () => {
            showAlert(i18n('importError') + ": Could not read file.", 'error');
            hideLoading();
             event.target.value = null;
        };
        reader.readAsText(file);
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOM Loaded. Initializing App...");
        showLoading();

        // Load settings first
        loadSettings();
        // Apply initial language based on loaded settings
        applyTranslations(currentSettings.language);

        // Setup Event Listeners (ensure elements exist first)
        const themeToggle = $('#theme-toggle');
        const langToggle = $('#language-toggle');
        const searchInput = $('#search-input');
        const gradeFilter = $('#filter-grade');
        const exportBtn = $('#export-data-btn');
        const importInput = $('#import-data-input');
        const importLabel = $('label[for="import-data-input"]');
        const disclaimerBtn = $('#show-disclaimer-btn');
        const saveNoteBtn = $('#save-note-btn');
        const deleteNoteBtn = $('#delete-note-btn');
        const addCatBtn = $('#add-category-btn');
        const saveCatBtn = $('#save-category-btn');
        const catPillsContainer = $('#category-pills-container');

        if(themeToggle) themeToggle.addEventListener('click', toggleTheme);
        if(langToggle) langToggle.addEventListener('click', toggleLanguage);
        if(searchInput) searchInput.addEventListener('input', handleSearchInput);
        if(gradeFilter) gradeFilter.addEventListener('change', handleGradeFilterChange);
        if(exportBtn) exportBtn.addEventListener('click', exportData);
        if(importInput) importInput.addEventListener('change', importData);
        if(importLabel) importLabel.addEventListener('click', (e) => { e.preventDefault(); triggerImport(); });
        if(disclaimerBtn) disclaimerBtn.addEventListener('click', () => showModal('disclaimer-modal'));
        if(saveNoteBtn) saveNoteBtn.addEventListener('click', saveNote);
        if(deleteNoteBtn) deleteNoteBtn.addEventListener('click', deleteNote);
        if(addCatBtn) addCatBtn.addEventListener('click', openAddCategoryModal);
        if(saveCatBtn) saveCatBtn.addEventListener('click', saveCategory);
        if(catPillsContainer) {
             const allCatBtn = catPillsContainer.querySelector('button[data-category-id="all"]');
             const bookmarkedCatBtn = catPillsContainer.querySelector('button[data-category-id="bookmarked"]');
             if(allCatBtn) allCatBtn.onclick = () => handleCategoryFilterClick('all');
             if(bookmarkedCatBtn) bookmarkedCatBtn.onclick = () => handleCategoryFilterClick('bookmarked');
        }

        try {
            await openDB();
            console.log("Database opened successfully.");

            // Check if initial data needs loading
            const narratorsCount = await performDBTransaction(STORE_NARRATORS, 'readonly', (store, resolve, reject) => {
                 const countRequest = store.count();
                 countRequest.onsuccess = () => resolve(countRequest.result);
                 countRequest.onerror = (e) => reject(e.target.error);
             });

             if (narratorsCount === 0) {
                 console.log("Narrator store is empty, loading initial data...");
                 await loadInitialData(); // This fetches CSV and calls loadAllDataFromDB
             } else {
                 console.log("Narrator store not empty, loading existing data from DB.");
                 await loadAllDataFromDB(); // Load existing data
             }

             // Show onboarding only on the very first visit (after potential initial load)
             if (!isOnboardingComplete()) {
                 showModal('onboarding-modal');
             }

        } catch (error) {
            console.error("Initialization failed:", error);
            showAlert(i18n('error') + `: ${error}`, 'error');
            const mainContent = $('#main-content-area');
            if(mainContent) mainContent.innerHTML = `<p class="text-danger bold">${i18n('error')}: Could not initialize the application. Please check browser compatibility or try clearing site data. Error: ${error}</p>`;
        } finally {
            hideLoading();
            console.log("Initialization complete.");
        }
    });

</script>
</body>
</html>